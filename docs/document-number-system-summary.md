# ‚úÖ ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏£‡∏∞‡∏ö‡∏ö Document Number Generation

## üë®‚Äçüíª Developer: ‡πÅ‡∏ï‡πâ‡∏° (Fullstack Laravel + React+MUI Expert)
**‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:** 17 ‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô 2025

---

## üéØ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°

1. **‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏•‡∏Ç‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà**: `QT202509-0014` ‚Üí `QT202510-0001`
2. **‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 2 ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó**
3. **‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Controllers ‡πÅ‡∏•‡∏∞ PDF Services ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô**

---

## ‚úÖ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö

### üîç 1. DocumentNumberService 
**‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:** ‚úÖ **‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß**

**‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏°‡∏µ:**
- ‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏•‡∏Ç‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
- ‚úÖ Global sequence ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (sync ‡∏Å‡∏±‡∏ô)
- ‚úÖ Thread-safe ‡∏î‡πâ‡∏ß‡∏¢ `lockForUpdate()`
- ‚úÖ Gap filling (‡∏´‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏ï‡∏¥‡∏°)

**‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:**
```
‡πÄ‡∏î‡∏∑‡∏≠‡∏ô 9/2025: QT202509-0015, QT202509-0016
‡πÄ‡∏î‡∏∑‡∏≠‡∏ô 10/2025: QT202510-0001, QT202510-0002 ‚Üê ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï!
```

### üéõÔ∏è 2. Controllers & Services
**‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:** ‚úÖ **‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß**

**Models ‡∏ó‡∏µ‡πà‡∏°‡∏µ generate methods:**
- `Quotation::generateQuotationNumber($companyId)`
- `Invoice::generateInvoiceNumber($companyId)` 
- `Receipt::generateReceiptNumber($companyId, $type)`
- `DeliveryNote::generateDeliveryNoteNumber($companyId)`

**Services ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ:**
- `QuotationService::approve()` ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏ï‡∏≠‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
- `InvoiceService` ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏ï‡∏≠‡∏ô approve
- `ReceiptService` ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏ï‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á
- `DeliveryNoteService` ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏ï‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á

### üìÑ 3. PDF Services  
**‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:** ‚úÖ **‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß**

**‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏Ç‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£:**
- `QuotationPdfService`: `$q->number ?? '-'` ‚úÖ
- `InvoicePdfMasterService`: `$invoice->number ?? $invoice->id` ‚úÖ
- **Fallback ‡∏î‡∏µ:** ‡πÉ‡∏ä‡πâ ID ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç

---

## üß™ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö

### Test 1: ‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà
```php
// ‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô 2025
Company 1: QT202509-0015
Company 2: QT202509-0016

// ‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏° 2025 - ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï!
Company 1: QT202510-0001 ‚Üê ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà
Company 2: QT202510-0002 ‚Üê ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á
```

### Test 2: ‡∏Å‡∏≤‡∏£ Sync ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
```php
// ‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö - last_number ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
- ‡∏ò‡∏ô ‡∏û‡∏•‡∏±‡∏™ quotation 2025/10: 4
- ‡∏ó‡∏µ‡πÄ‡∏≠‡πá‡∏ô‡∏û‡∏µ quotation 2025/10: 4 ‚Üê ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô!
```

### Test 3: ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
```php
QT202510-0001  // Quotation
INV202510-0001 // Invoice - ‡∏ô‡∏±‡∏ö‡πÅ‡∏¢‡∏Å‡∏Å‡∏±‡∏ô
```

---

## üé® UX/UI Considerations

### 1. **Draft vs Final Numbers**
- **Draft**: `DRAFT-XXXXXXXX` (‡πÉ‡∏ä‡πâ UUID suffix)
- **Final**: `QT202510-0001` (‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≠‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)
- **Benefits**: ‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏•‡∏Ç‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å draft

### 2. **PDF Fallbacks**
- ‚úÖ ‡πÅ‡∏™‡∏î‡∏á `-` ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç (quotation draft)
- ‚úÖ ‡πÅ‡∏™‡∏î‡∏á ID ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç (invoice draft) 
- **Elegant degradation**: ‡πÑ‡∏°‡πà error, user-friendly

### 3. **Consistent Numbering UX**
- ‚úÖ ‡πÄ‡∏•‡∏Ç‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
- ‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
- ‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á confusing users

---

## üîß Technical Architecture

### ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö Global Sequence:

```php
// 1. ‡∏´‡∏≤ max ‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
$globalMaxSeq = DocumentSequence::where([
    'doc_type' => $docType,
    'year' => $year,
    'month' => $month
])->max('last_number');

// 2. ‡πÉ‡∏ä‡πâ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
$seqNumber = $globalMaxSeq + 1;

// 3. Sync ‡∏ó‡∏∏‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
DocumentSequence::where([...])
    ->where('company_id', '!=', $companyId)
    ->update(['last_number' => DB::raw("GREATEST(last_number, $seqNumber)")]);
```

---

## üöÄ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢

### ‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
1. ‚úÖ **‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà**: ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
2. ‚úÖ **‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó**: Sync ‡∏ó‡∏∏‡∏Å transaction  
3. ‚úÖ **Controllers Integration**: ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
4. ‚úÖ **PDF Services**: ‡∏°‡∏µ fallback ‡∏î‡∏µ, UX ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢
5. ‚úÖ **Thread Safety**: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô race condition
6. ‚úÖ **Gap Filling**: ‡∏´‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ

### üìä Document Sequences ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:
```
- ‡∏ò‡∏ô ‡∏û‡∏•‡∏±‡∏™ quotation 2025/8: 8
- ‡∏ó‡∏µ‡πÄ‡∏≠‡πá‡∏ô‡∏û‡∏µ quotation 2025/8: 8
- ‡∏ò‡∏ô ‡∏û‡∏•‡∏±‡∏™ quotation 2025/9: 16  
- ‡∏ó‡∏µ‡πÄ‡∏≠‡πá‡∏ô‡∏û‡∏µ quotation 2025/9: 16
- ‡∏ò‡∏ô ‡∏û‡∏•‡∏±‡∏™ quotation 2025/10: 4 ‚Üê ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß
- ‡∏ó‡∏µ‡πÄ‡∏≠‡πá‡∏ô‡∏û‡∏µ quotation 2025/10: 4 ‚Üê ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß
```

---

## üí° Recommendations

### 1. **Monitoring**
```php
// ‡πÄ‡∏û‡∏¥‡πà‡∏° logging ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà
Log::info('Month reset detected', [
    'doc_type' => $docType,
    'year' => $year, 
    'month' => $month,
    'new_sequence' => 1
]);
```

### 2. **API Endpoint**
```php
// ‡πÄ‡∏û‡∏¥‡πà‡∏° endpoint ‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ sequence
GET /api/v1/document-sequences
```

### 3. **Frontend UI**
```jsx
// ‡πÅ‡∏™‡∏î‡∏á next number preview ‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
<Typography variant="caption">
  ‡πÄ‡∏•‡∏Ç‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: QT{currentMonth}-{nextNumber.toString().padStart(4, '0')}
</Typography>
```

---

## üéâ Conclusion

**‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß!** 

- **Backend**: DocumentNumberService ‡∏Ñ‡∏£‡∏ö‡∏Ñ‡∏£‡∏±‡∏ô
- **Integration**: Controllers & Services ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á  
- **PDF**: ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢
- **UX**: ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏î‡∏µ ‡πÑ‡∏°‡πà‡∏™‡∏±‡∏ö‡∏™‡∏ô
- **Performance**: Thread-safe ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û

**‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°** - ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á! üöÄ

---

*Developer: ‡πÅ‡∏ï‡πâ‡∏° | ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: 17 ‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô 2025*