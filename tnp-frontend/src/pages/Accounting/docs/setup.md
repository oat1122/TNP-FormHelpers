# 🔄 Flow การทำงานระบบบัญชี แบบ FlowAccount
## คู่มือสำหรับ AI Developer - Simple & Clear Workflow

---

## 📋 สารบัญ

1. [ภาพรวม Flow หลัก](#overview)
2. [บทบาทการทำงาน 2 Role](#roles)
3. [Step 0: นำเข้างานจากระบบ Pricing](#step-0)
4. [Step 1: ใบเสนอราคา](#step-1)
5. [Step 2: ใบแจ้งหนี้](#step-2)
6. [Step 3: ใบเสร็จ/ใบกำกับภาษี](#step-3)
7. [Step 4: ใบส่งของ](#step-4)
8. [การจัดการกรณีพิเศษ](#exceptions)
9. [Technical Implementation](#technical)
10. [คำสั่งสำหรับ AI](#ai-commands)

---

## 🎯 ภาพรวม Flow หลัก {#overview}

### สรุป Flow ระบบ (4 ขั้นตอนหลัก)
```
ระบบ Pricing → ใบเสนอราคา → ใบแจ้งหนี้ → ใบเสร็จ/ใบกำกับภาษี → ใบส่งของ
   (ดึงงาน)      (สร้างและอนุมัติ)   (เรียกเก็บเงิน)     (รับชำระ)        (ส่งสินค้า)
```

### 🎨 แนวคิดหลัก FlowAccount
- **One-Click Conversion** - แปลงเอกสารคลิกเดียว
- **Auto Data Transfer** - ดึงข้อมูลอัตโนมัติไม่ต้องพิมพ์ซ้ำ
- **Status Tracking** - ติดตามสถานะได้ทุกขั้นตอน
- **Role-Based Workflow** - แต่ละคนทำหน้าที่ของตัวเองชัดเจน
- **Exception Handling** - จัดการกรณีพิเศษได้ยืดหยุ่น

---

## 👥 บทบาทการทำงาน 2 Role {#roles}

### 🔵 Sales (ฝ่ายขาย)
```
หน้าที่หลัก:
✅ สร้างใบเสนอราคาจากงาน Pricing
✅ แก้ไขเอกสารที่ตัวเองสร้าง (เฉพาะสถานะ draft)
✅ ส่งเอกสารเพื่อตรวจสอบ
✅ ดาวน์โหลดและส่งเอกสารให้ลูกค้า
✅ อัปโหลดหลักฐานการส่งเอกสาร
✅ บันทึกการรับเงินมัดจำ (ถ้ามี)

ข้อจำกัด:
❌ ไม่สามารถอนุมัติเอกสารได้
❌ ไม่สามารถแก้ไขเอกสารหลังอนุมัติแล้ว
❌ ไม่สามารถสร้างใบเสนอราคาได้ (เฉพาะ Account เท่านั้น)
❌ ไม่สามารถย้อนกลับสถานะได้
```

### 🟢 Account (ฝ่ายบัญชี)
```
หน้าที่หลัก:
✅ อนุมัติ/ปฏิเสธเอกสารทุกประเภท
✅ แก้ไขเอกสารได้ทุกขั้นตอน
✅ ย้อนกลับสถานะเอกสาร
✅ ควบคุมการคำนวณภาษี VAT
✅ จัดการการเงินและการชำระ
✅ สร้างเอกสารปรับยอด (Credit/Debit Note)
✅ ออกรายงานการเงิน

อำนาจพิเศษ:
🔥 สามารถแก้ไขได้ทุกเอกสาร ทุกสถานะ
🔥 สามารถลบเอกสารได้ (ยกเว้นที่มี reference แล้ว)
🔥 สามารถย้อนกลับ Flow ได้
🔥 ไม่สามารถสร้างใบเสนอราคาเริ่มต้นได้ (ต้องมาจาก Pricing)
```

---

## 🚀 Step 0: นำเข้างานจากระบบ Pricing {#step-0}

### AI Command
```bash
สร้างหน้าดึงงานจากระบบ Pricing ที่แสดงงานที่สถานะ "Complete" 
และให้ Sales สามารถเลือกงานเพื่อสร้างใบเสนอราคาได้
```

### UI Design
```
Pricing System Integration:
┌─────────────────────────────────────────────────────────────┐
│ 📊 งานใหม่จากระบบ Pricing                                   │
│                                                             │
│ Filter: [🔍 ค้นหา] [📅 วันที่] [👤 ลูกค้า] [🔄 รีเฟรช]      │
│                                                             │
│ ┌─ งานที่พร้อมออกใบเสนอราคา ─────────────────────────────┐  │
│ │ ✅ PRC-2025-001  บริษัท ABC จำกัด     ฿125,000      │  │
│ │    งานพิมพ์โบรชัวร์ A4 4 สี                          │  │
│ │    สถานะ: Complete | วันที่เสร็จ: 15 ม.ค. 2568        │  │
│ │    [📋 สร้างใบเสนอราคา] [👁️ ดูรายละเอียด]            │  │
│ │                                                     │  │
│ │ ✅ PRC-2025-002  ร้าน XYZ            ฿89,500       │  │
│ │    บริการติดตั้งระบบ                                 │  │
│ │    สถานะ: Complete | วันที่เสร็จ: 14 ม.ค. 2568        │  │
│ │    [📋 สร้างใบเสนอราคา] [👁️ ดูรายละเอียด]            │  │
│ └─────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### Flow Logic
```
1. ระบบ Pricing ส่งสัญญาณ "Complete"
2. แสดงงานในหน้า "งานใหม่" ของ Sales
3. Sales เลือกงานเพื่อสร้างใบเสนอราคา
4. ดึงข้อมูลลูกค้าและรายการอัตโนมัติ
5. Sales กรอกเงื่อนไขเพิ่มเติม (การชำระ, มัดจำ)
```

### Technical Implementation
```javascript
// API Integration
const usePricingJobs = () => {
  return useQuery({
    queryKey: ['pricing-jobs'],
    queryFn: () => pricingApi.getCompletedJobs(),
    refetchInterval: 30000, // Check ทุก 30 วินาที
  });
};

// สร้างใบเสนอราคาจากงาน Pricing
const createQuotationFromPricing = async (pricingJobId) => {
  const pricingData = await pricingApi.getJobDetail(pricingJobId);
  const quotationData = {
    pricing_job_id: pricingJobId,
    customer_id: pricingData.customer_id,
    items: pricingData.items,
    estimated_total: pricingData.total_cost,
    status: 'draft'
  };
  return quotationApi.create(quotationData);
};
```

---

## 📄 Step 1: ใบเสนอราคา (Quotation Flow) {#step-1}

### AI Command
```bash
สร้าง Quotation Flow ที่มี 3 ขั้นตอน:
1. Sales สร้างและแก้ไข
2. Account ตรวจสอบและอนุมัติ  
3. Sales ส่งให้ลูกค้าและอัปโหลดหลักฐาน
พร้อม role-based permissions และ status tracking
```

### ขั้นตอน 1.1: Sales สร้างใบเสนอราคา

```
Create Quotation Form:
┌─────────────────────────────────────────────────────────────┐
│ สร้างใบเสนอราคาจาก PRC-2025-001                              │
│                                                             │
│ ┌─ ข้อมูลจาก Pricing (Auto-filled) ─────────────────────┐  │
│ │ ลูกค้า: บริษัท ABC จำกัด                              │  │
│ │ งาน: งานพิมพ์โบรชัวร์ A4 4 สี                          │  │
│ │ รายการ: โบรชัวร์ A4 - 2 ชิ้น × ฿25,000 = ฿50,000      │  │
│ │ ยอดก่อนภาษี: ฿50,000.00                               │  │
│ │ VAT 7%: ฿3,500.00                                      │  │
│ │ ยอดรวม: ฿53,500.00                                     │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ ┌─ เงื่อนไขการชำระ (Sales เลือก) ─────────────────────────┐  │
│ │ การชำระเงิน:                                            │  │
│ │ ○ เงินสด  ● เครดิต 30 วัน  ○ เครดิต 60 วัน            │  │
│ │                                                         │  │
│ │ เงินมัดจำ:                                              │  │
│ │ ○ ไม่มี  ● 50%  ○ 100%  ○ กำหนดเอง [    ]%            │  │
│ │                                                         │  │
│ │ จำนวนมัดจำ: ฿26,750.00                                 │  │
│ │ ยอดคงเหลือ: ฿26,750.00                                 │  │
│ │                                                         │  │
│ │ วันครบกำหนด: [📅 28 ม.ค. 2568] (30 วันจากวันนี้)       │  │
│ │ หมายเหตุ: [ราคานี้รวมค่าจัดส่งและติดตั้งแล้ว...]        │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ [ยกเลิก] [บันทึกร่าง] [ส่งตรวจสอบ]                         │
└─────────────────────────────────────────────────────────────┘
```

### ขั้นตอน 1.2: Account ตรวจสอบและอนุมัติ

```
Approval Interface:
┌─────────────────────────────────────────────────────────────┐
│ ตรวจสอบใบเสนอราคา QT202501-0045                             │
│                                                             │
│ ┌─ ข้อมูลเอกสาร ─────────────────────────────────────────┐  │
│ │ สร้างโดย: คุณสมชาย (ฝ่ายขาย)                            │  │
│ │ วันที่สร้าง: 15 ม.ค. 2568 10:30                        │  │
│ │ ลูกค้า: บริษัท ABC จำกัด                               │  │
│ │ ยอดรวม: ฿53,500.00                                     │  │
│ │ เงื่อนไข: เครดิต 30 วัน, มัดจำ 50%                     │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ ┌─ การตรวจสอบ ───────────────────────────────────────────┐  │
│ │ ✅ ข้อมูลลูกค้าถูกต้อง                                  │  │
│ │ ✅ ราคาสินค้าตรงตาม Pricing                            │  │
│ │ ✅ การคำนวณ VAT ถูกต้อง                                │  │
│ │ ⚠️ ควรปรับเงื่อนไขเครดิตเป็น 45 วัน                   │  │
│ │                                                         │  │
│ │ หมายเหตุการตรวจสอบ:                                    │  │
│ │ [ข้อมูลถูกต้องครบถ้วน แนะนำให้อนุมัติ]                  │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ [❌ ปฏิเสธ] [✏️ ส่งกลับแก้ไข] [📝 แก้ไขและอนุมัติ] [✅ อนุมัติ] │
└─────────────────────────────────────────────────────────────┘
```

### ขั้นตอน 1.3: Sales ส่งเอกสารให้ลูกค้า

```
Send Document Interface:
┌─────────────────────────────────────────────────────────────┐
│ ส่งใบเสนอราคา QT202501-0045 (อนุมัติแล้ว)                   │
│                                                             │
│ ┌─ การส่งเอกสาร ─────────────────────────────────────────┐  │
│ │ 📄 ไฟล์ PDF: [quotation-QT202501-0045.pdf]             │  │
│ │ [📥 ดาวน์โหลด PDF] [🖨️ พิมพ์]                           │  │
│ │                                                         │  │
│ │ 📧 ส่งอีเมล:                                            │  │
│ │ ถึง: [contact@abc-company.com]                          │  │
│ │ หัวข้อ: [ใบเสนอราคา QT202501-0045 จาก TNP Group]       │  │
│ │ ข้อความ: [เรียน คุณลูกค้า ได้แนบใบเสนอราคา...]          │  │
│ │ [📧 ส่งอีเมลทันที]                                      │  │
│ │                                                         │  │
│ │ 📎 หลักฐานการส่ง:                                       │  │
│ │ [📁 อัปโหลดรูปภาพ/ไฟล์หลักฐาน]                          │  │
│ │ • รูปหน้าจอการส่งอีเมล                                  │  │
│ │ • รูปใบเซ็นรับ (ถ้าส่งด้วยตัว)                          │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ [📋 บันทึกการส่ง] [✅ ลูกค้าตอบรับแล้ว]                     │
└─────────────────────────────────────────────────────────────┘
```

### Status Flow Diagram
```
Quotation Status Flow:

draft → pending_review → approved → sent → completed
  ↑         ↑              ↑         ↑        ↑
Sales    Account       Account   Sales   Sales

Rejected Flow:
pending_review → rejected → draft (edit again)
                     ↑         ↓
                 Account   Sales
```

### Role-Based Actions
```javascript
const QUOTATION_STATUSES = {
  DRAFT: 'draft',                    // ร่าง (Sales สร้าง)
  PENDING_REVIEW: 'pending_review',  // รอตรวจสอบ (ส่งให้ Account)
  APPROVED: 'approved',              // อนุมัติแล้ว (Account อนุมัติ)
  REJECTED: 'rejected',              // ปฏิเสธ (Account ปฏิเสธ)
  SENT: 'sent',                      // ส่งลูกค้าแล้ว (Sales ส่ง)
  COMPLETED: 'completed'             // สำเร็จ (ลูกค้าตอบรับ)
};

// Role-based Actions
const getAvailableActions = (status, userRole) => {
  const actions = {
    [QUOTATION_STATUSES.DRAFT]: {
      sales: ['edit', 'delete', 'submit_for_review'],
      account: ['edit', 'delete', 'approve', 'reject']
    },
    [QUOTATION_STATUSES.PENDING_REVIEW]: {
      sales: ['view'],
      account: ['approve', 'reject', 'send_back_for_edit']
    },
    [QUOTATION_STATUSES.APPROVED]: {
      sales: ['download_pdf', 'send_email', 'upload_evidence', 'mark_completed'],
      account: ['view', 'revoke_approval', 'create_invoice']
    },
    [QUOTATION_STATUSES.SENT]: {
      sales: ['mark_completed'],
      account: ['view', 'create_invoice']
    },
    [QUOTATION_STATUSES.COMPLETED]: {
      sales: ['view'],
      account: ['view', 'create_invoice']
    }
  };
  return actions[status]?.[userRole] || [];
};
```

---

## 💰 Step 2: ใบแจ้งหนี้ (Invoice Flow) {#step-2}

### AI Command
```bash
สร้าง One-Click Conversion จากใบเสนอราคาเป็นใบแจ้งหนี้ 
พร้อมระบบเลือกประเภทการเรียกเก็บ (เต็มจำนวน/ส่วนที่เหลือ/บางส่วน)
และระบบติดตามการชำระเงิน
```

### ขั้นตอน 2.1: One-Click Conversion

```
Invoice Creation from Quotation:
┌─────────────────────────────────────────────────────────────┐
│ สร้างใบแจ้งหนี้จากใบเสนอราคา QT202501-0045                  │
│                                                             │
│ ┌─ ข้อมูลต้นฉบับ ────────────────────────────────────────┐  │
│ │ 📋 ใบเสนอราคา: QT202501-0045                          │  │
│ │ 👤 ลูกค้า: บริษัท ABC จำกัด                            │  │
│ │ 💰 ยอดรวมใบเสนอราคา: ฿53,500.00                       │  │
│ │ 💵 เงินมัดจำ: ฿26,750.00 (50%)                        │  │
│ │ 💳 ยอดคงเหลือ: ฿26,750.00                             │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ ┌─ ตัวเลือกการเรียกเก็บ ──────────────────────────────────┐  │
│ │ ประเภทใบแจ้งหนี้:                                       │  │
│ │ ○ เรียกเก็บเต็มจำนวน (฿53,500.00)                      │  │
│ │ ● เรียกเก็บส่วนที่เหลือ (฿26,750.00) - หลังหักมัดจำ     │  │
│ │ ○ เรียกเก็บบางส่วน [         ] บาท                     │  │
│ │                                                         │  │
│ │ เลขที่ใบแจ้งหนี้: [INV202501-0123] (auto-generate)     │  │
│ │ วันที่ออกใบ: [16 ม.ค. 2568]                            │  │
│ │ วันครบกำหนดชำระ: [15 ก.พ. 2568] (30 วันจากออกใบ)      │  │
│ │                                                         │  │
│ │ หมายเหตุ: [กรุณาชำระภายในกำหนด เพื่อหลีกเลี่ยงค่าปรับ]  │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ ┌─ รายการสินค้า (คัดลอกจากใบเสนอราคา) ──────────────────┐  │
│ │ 1. งานพิมพ์โบรชัวร์ A4 4 สี                            │  │
│ │    จำนวน: 2 ชิ้น × ฿25,000.00 = ฿50,000.00           │  │
│ │                                                         │  │
│ │ รวมก่อนภาษี: ฿50,000.00                                │  │
│ │ VAT 7%: ฿3,500.00                                      │  │
│ │ รวมทั้งสิ้น: ฿53,500.00                                 │  │
│ │ หักเงินมัดจำ: -฿26,750.00                              │  │
│ │ ยอดที่ต้องชำระ: ฿26,750.00                             │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ [ยกเลิก] [บันทึกร่าง] [สร้างใบแจ้งหนี้]                    │
└─────────────────────────────────────────────────────────────┘
```

### ขั้นตอน 2.2: Account ตรวจสอบและอนุมัติ

```
Invoice Approval Interface:
┌─────────────────────────────────────────────────────────────┐
│ ตรวจสอบใบแจ้งหนี้ INV202501-0123                            │
│                                                             │
│ ┌─ การตรวจสอบข้อมูล ─────────────────────────────────────┐  │
│ │ ✅ อ้างอิงใบเสนอราคาถูกต้อง (QT202501-0045)             │  │
│ │ ✅ การคำนวณยอดถูกต้อง                                   │  │
│ │ ✅ เงื่อนไขการชำระตรงตามสัญญา                           │  │
│ │                                                         │  │
│ │ การปรับแต่งเพิ่มเติม (ถ้าจำเป็น):                        │  │
│ │ Credit Term: [30 วัน ▼] (ปรับได้)                       │  │
│ │ รวมบิลกับออเดอร์อื่น: [☐ รวมกับ INV202501-0122]         │  │
│ │ ข้อมูลภาษี: [☐ แก้ไขที่อยู่ภาษี] [☐ เปลี่ยนเลขภาษี]     │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ ┌─ ผลการตรวจสอบ ─────────────────────────────────────────┐  │
│ │ หมายเหตุ: [ข้อมูลครบถ้วนถูกต้อง พร้อมส่งลูกค้า]         │  │
│ │                                                         │  │
│ │ [❌ ปฏิเสธ] [✏️ ส่งกลับแก้ไข] [✅ อนุมัติและส่ง]        │  │
│ └─────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### ขั้นตอน 2.3: ส่งใบแจ้งหนี้และติดตามการชำระ

```
Invoice Tracking Interface:
┌─────────────────────────────────────────────────────────────┐
│ ใบแจ้งหนี้ INV202501-0123 - ติดตามการชำระ                   │
│                                                             │
│ ┌─ สถานะการชำระ ─────────────────────────────────────────┐  │
│ │ สถานะ: 🟡 รอชำระ                                       │  │
│ │ ยอดที่ต้องชำระ: ฿26,750.00                             │  │
│ │ ชำระแล้ว: ฿0.00                                        │  │
│ │ คงเหลือ: ฿26,750.00                                     │  │
│ │ วันครบกำหนด: 15 ก.พ. 2568 (เหลือ 12 วัน)               │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ ┌─ การส่งและติดตาม ──────────────────────────────────────┐  │
│ │ ส่งใบแจ้งหนี้:                                          │  │
│ │ [📧 ส่งอีเมล] [📱 ส่ง SMS] [🔗 สร้างลิงก์ออนไลน์]       │  │
│ │                                                         │  │
│ │ ประวัติการติดตาม:                                        │  │
│ │ ✅ 16 ม.ค. ส่งอีเมลใบแจ้งหนี้                          │  │
│ │ ✅ 20 ม.ค. โทรติดตาม - ลูกค้ารับทราบ                   │  │
│ │ ⏰ 25 ม.ค. ส่งการแจ้งเตือนอัตโนมัติ                     │  │
│ │                                                         │  │
│ │ [📞 บันทึกการติดตาม] [⚠️ ส่งการแจ้งเตือน]                │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ ┌─ บันทึกการชำระ ────────────────────────────────────────┐  │
│ │ เมื่อลูกค้าชำระเงิน:                                    │  │
│ │ [💰 บันทึกการชำระ] [🧾 สร้างใบเสร็จอัตโนมัติ]          │  │
│ └─────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### Payment Status Flow
```
Invoice Payment Flow:

pending → partial_paid → fully_paid
   ↓           ↓            ↑
overdue    overdue      success

Status Colors:
🟢 fully_paid - จ่ายแล้ว
🟡 pending - รอชำระ  
🔴 overdue - เกินกำหนด
🔵 partial_paid - จ่ายบางส่วน
⚫ cancelled - ยกเลิก
```

---

## 🧾 Step 3: ใบเสร็จ/ใบกำกับภาษี (Receipt/Tax Invoice Flow) {#step-3}

### AI Command
```bash
สร้างระบบบันทึกการชำระเงินและออกใบเสร็จ/ใบกำกับภาษีอัตโนมัติ
พร้อมการคำนวณ VAT และ running number ตามมาตรฐาน
```

### ขั้นตอน 3.1: บันทึกการชำระเงิน

```
Payment Recording Interface:
┌─────────────────────────────────────────────────────────────┐
│ บันทึกการชำระเงิน - INV202501-0123                          │
│                                                             │
│ ┌─ ข้อมูลใบแจ้งหนี้ ──────────────────────────────────────┐  │
│ │ 💰 ใบแจ้งหนี้: INV202501-0123                          │  │
│ │ 👤 ลูกค้า: บริษัท ABC จำกัด                            │  │
│ │ 💵 ยอดรวม: ฿26,750.00                                 │  │
│ │ 💳 ชำระแล้ว: ฿0.00                                    │  │
│ │ 🔥 คงเหลือ: ฿26,750.00                                │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ ┌─ รายละเอียดการชำระ ─────────────────────────────────────┐  │
│ │ 📅 วันที่ชำระ: [20 ม.ค. 2568]                          │  │
│ │ 💰 จำนวนเงิน: [26,750.00] บาท                         │  │
│ │                                                         │  │
│ │ 💳 วิธีการชำระ:                                        │  │
│ │ ○ เงินสด                                               │  │
│ │ ● โอนเงิน                                              │  │
│ │ ○ เช็ค                                                 │  │
│ │ ○ บัตรเครดิต                                           │  │
│ │                                                         │  │
│ │ 🏦 ธนาคาร: [กสิกรไทย ▼]                               │  │
│ │ 🔢 เลขที่อ้างอิง: [TXN-20250120-001]                  │  │
│ │ 📝 หมายเหตุ: [ชำระผ่านการโอนเงิน]                     │  │
│ │                                                         │  │
│ │ 📎 หลักฐานการชำระ:                                     │  │
│ │ [📁 อัปโหลดสลิป/ใบเสร็จ] - slip_20250120.jpg         │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ [ยกเลิก] [บันทึกการชำระ] [บันทึก + สร้างใบเสร็จ]           │
└─────────────────────────────────────────────────────────────┘
```

### ขั้นตอน 3.2: สร้างใบเสร็จ/ใบกำกับภาษีอัตโนมัติ

```
Auto Receipt Generation:
┌─────────────────────────────────────────────────────────────┐
│ สร้างใบเสร็จ/ใบกำกับภาษีอัตโนมัติ                           │
│                                                             │
│ ┌─ ข้อมูลการชำระ ─────────────────────────────────────────┐  │
│ │ การชำระ: ฿26,750.00 (ชำระครบแล้ว)                      │  │
│ │ วันที่ชำระ: 20 ม.ค. 2568                               │  │
│ │ วิธีการ: โอนเงิน (TXN-20250120-001)                    │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ ┌─ ประเภทเอกสารที่จะออก ─────────────────────────────────┐  │
│ │ เลือกประเภท:                                           │  │
│ │ ○ ใบเสร็จธรรมดา (ไม่มี VAT)                            │  │
│ │ ● ใบกำกับภาษี (มี VAT 7%)                              │  │
│ │ ○ ใบกำกับภาษี/ใบเสร็จ (เต็มรูปแบบ)                     │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ ┌─ การคำนวณอัตโนมัติ ────────────────────────────────────┐  │
│ │ ยอดชำระ: ฿26,750.00                                   │  │
│ │                                                         │  │
│ │ การแยก VAT (ราคารวม VAT แล้ว):                          │  │
│ │ ยอดก่อนภาษี: ฿25,000.00                               │  │
│ │ VAT 7%: ฿1,750.00                                      │  │
│ │ ยอดรวม: ฿26,750.00                                     │  │
│ │                                                         │  │
│ │ เลขที่เอกสาร: [RCPT202501-0089] (Auto-generate)       │  │
│ │ เลขที่กำกับภาษี: [AA12345678901-002568-001]            │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ [สร้างใบเสร็จ/ใบกำกับภาษี]                                │
└─────────────────────────────────────────────────────────────┘
```

### ขั้นตอน 3.3: Account ตรวจสอบและอนุมัติ

```
Final Receipt Approval:
┌─────────────────────────────────────────────────────────────┐
│ ตรวจสอบใบเสร็จ/ใบกำกับภาษี RCPT202501-0089                 │
│                                                             │
│ ┌─ รายละเอียดเอกสาร ─────────────────────────────────────┐  │
│ │ ประเภท: ใบกำกับภาษี (VAT Invoice)                       │  │
│ │ อ้างอิง: INV202501-0123 (ใบแจ้งหนี้)                    │  │
│ │ การชำระ: โอนเงิน ฿26,750.00                            │  │
│ │ VAT: ฿1,750.00 (7% ของ ฿25,000.00)                     │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ ┌─ การตรวจสอบสุดท้าย ────────────────────────────────────┐  │
│ │ ✅ การคำนวณ VAT ถูกต้อง                                │  │
│ │ ✅ เลขที่เอกสารตรงตาม Format                           │  │
│ │ ✅ ข้อมูลลูกค้าครบถ้วน                                 │  │
│ │                                                         │  │
│ │ การปรับแต่งล่าสุด (ถ้าจำเป็น):                          │  │
│ │ ที่อยู่จัดส่ง: [☐ ใช้ที่อยู่ลูกค้า] [☐ ที่อยู่อื่น]     │  │
│ │ หมายเหตุพิเศษ: [ขอบคุณที่ใช้บริการ]                    │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ ┌─ ผลกระทบเมื่ออนุมัติ ──────────────────────────────────┐  │
│ │ เมื่ออนุมัติแล้ว:                                       │  │
│ │ • ระบบจะรันเลขใบกำกับภาษีอัตโนมัติ                     │  │
│ │ • อัปเดตสต็อกสินค้า (ถ้ามี)                            │  │
│ │ • เปลี่ยนสถานะใบแจ้งหนี้เป็น "ชำระแล้ว"                │  │
│ │ • สามารถสร้างใบส่งของได้                               │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ [❌ ปฏิเสธ] [✏️ แก้ไข] [✅ อนุมัติและออกเอกสาร]            │
└─────────────────────────────────────────────────────────────┘
```

### VAT Calculation Logic
```javascript
// ระบบคำนวณ VAT แบบ FlowAccount
const calculateVAT = (amount, vatRate = 0.07, priceIncludesVat = true) => {
  if (priceIncludesVat) {
    // ราคารวม VAT แล้ว (แยกย้อนกลับ)
    const beforeVat = amount / (1 + vatRate);
    const vatAmount = amount - beforeVat;
    return {
      beforeVat: Math.round(beforeVat * 100) / 100,
      vatAmount: Math.round(vatAmount * 100) / 100,
      totalAmount: amount
    };
  } else {
    // ราคายังไม่รวม VAT (คำนวณเพิ่ม)
    const vatAmount = amount * vatRate;
    const totalAmount = amount + vatAmount;
    return {
      beforeVat: amount,
      vatAmount: Math.round(vatAmount * 100) / 100,
      totalAmount: Math.round(totalAmount * 100) / 100
    };
  }
};

// Auto Generate Document Number
const generateDocumentNumber = (type, date = new Date()) => {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const sequence = getNextSequenceNumber(type, year, month);
  
  const formats = {
    receipt: `RCPT${year}${month}-${sequence.toString().padStart(4, '0')}`,
    tax_invoice: `TAX${year}${month}-${sequence.toString().padStart(4, '0')}`,
    delivery_note: `DN${year}${month}-${sequence.toString().padStart(4, '0')}`
  };
  
  return formats[type];
};
```

---

## 📦 Step 4: ใบส่งของ (Delivery Note Flow) {#step-4}

### AI Command
```bash
สร้างระบบใบส่งของพร้อมติดตามสถานะการจัดส่ง 
รองรับการส่งด้วยตัวเอง บริษัทขนส่ง และลูกค้ามารับเอง
พร้อม timeline tracking และ integration กับระบบขนส่ง
```

### ขั้นตอน 4.1: สร้างใบส่งของ

```
Create Delivery Note:
┌─────────────────────────────────────────────────────────────┐
│ สร้างใบส่งของจากใบเสร็จ RCPT202501-0089                     │
│                                                             │
│ ┌─ ข้อมูลต้นฉบับ ────────────────────────────────────────┐  │
│ │ อ้างอิง: RCPT202501-0089 (ใบเสร็จ/ใบกำกับภาษี)         │  │
│ │ ลูกค้า: บริษัท ABC จำกัด                              │  │
│ │ ยอดเงิน: ฿26,750.00 (ชำระแล้ว)                       │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ ┌─ รายการส่ง ────────────────────────────────────────────┐  │
│ │ รายการสินค้า/บริการ:                                    │  │
│ │ ✅ งานพิมพ์โบรชัวร์ A4 4 สี                            │  │
│ │    จำนวน: 2 ชิ้น                                      │  │
│ │    น้ำหนัก: 5 กก.                                      │  │
│ │    ขนาดพัสดุ: 50×35×10 ซม.                             │  │
│ │                                                         │  │
│ │ หมายเหตุสินค้า: [ห่อด้วยพลาสติกกันน้ำ]                 │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ ┌─ ข้อมูลการจัดส่ง ──────────────────────────────────────┐  │
│ │ วันที่ส่ง: [22 ม.ค. 2568]                              │  │
│ │ เวลาส่ง: [09:00] น.                                   │  │
│ │                                                         │  │
│ │ ที่อยู่ส่ง:                                             │  │
│ │ [📍 ใช้ที่อยู่ลูกค้า] [📝 ที่อยู่อื่น]                  │  │
│ │ 123 ถนนสุขุมวิท แขวงคลองเตย เขตคลองเตย กรุงเทพฯ 10110  │  │
│ │                                                         │  │
│ │ ผู้รับ: [คุณสมชาย สมิท]                               │  │
│ │ เบอร์ติดต่อ: [02-123-4567]                             │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ ┌─ วิธีการส่ง ───────────────────────────────────────────┐  │
│ │ เลือกวิธีการส่ง:                                       │  │
│ │ ○ ส่งเอง (พนักงานบริษัท)                               │  │
│ │ ● บริษัทขนส่ง                                          │  │
│ │ ○ ลูกค้ามารับเอง                                       │  │
│ │                                                         │  │
│ │ บริษัทขนส่ง: [Kerry Express ▼]                         │  │
│ │ ประเภทบริการ: [Express ▼]                              │  │
│ │ ค่าส่ง: [฿150.00] (ลูกค้าจ่าย/บริษัทจ่าย)               │  │
│ │ Tracking Number: [จะได้รับหลังส่ง]                     │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ [ยกเลิก] [บันทึกร่าง] [สร้างใบส่งของ]                      │
└─────────────────────────────────────────────────────────────┘
```

### ขั้นตอน 4.2: ติดตามสถานะการส่ง

```
Delivery Tracking Interface:
┌─────────────────────────────────────────────────────────────┐
│ ใบส่งของ DN202501-0056 - ติดตามสถานะ                        │
│                                                             │
│ ┌─ สถานะปัจจุบัน ────────────────────────────────────────┐  │
│ │ สถานะ: 🟡 กำลังส่ง                                     │  │
│ │ ผู้ส่ง: Kerry Express                                  │  │
│ │ Tracking: ABC123456789                                  │  │
│ │ คาดว่าจะถึง: 23 ม.ค. 2568 ก่อน 18:00                   │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ ┌─ Timeline การส่ง ──────────────────────────────────────┐  │
│ │ ✅ 22 ม.ค. 09:00 - สร้างใบส่งของ                      │  │
│ │ ✅ 22 ม.ค. 10:30 - มอบให้ Kerry Express               │  │
│ │ ✅ 22 ม.ค. 12:00 - รับที่ศูนย์กระจายสินค้า             │  │
│ │ ✅ 22 ม.ค. 14:00 - ออกจากศูนย์กระจาย กทม.              │  │
│ │ 🟡 22 ม.ค. 18:00 - อยู่ระหว่างขนส่ง                   │  │
│ │ ⏳ 23 ม.ค. 16:00 - คาดว่าจะส่งถึงลูกค้า                │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ ┌─ การติดตามและอัปเดต ───────────────────────────────────┐  │
│ │ [🚚 ติดตามพัสดุ] [📞 ติดต่อขนส่ง] [📱 แจ้งลูกค้า]        │  │
│ │                                                         │  │
│ │ บันทึกการติดตาม:                                        │  │
│ │ 22 ม.ค. 15:00 - โทรแจ้งลูกค้าว่าสินค้าออกแล้ว          │  │
│ │ [📝 เพิ่มบันทึกใหม่]                                    │  │
│ │                                                         │  │
│ │ เมื่อส่งสำเร็จ:                                          │  │
│ │ [✅ ยืนยันการส่งสำเร็จ] [📋 อัปโหลดใบรับสินค้า]          │  │
│ └─────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### ขั้นตอน 4.3: ปิดงานและสรุป

```
Job Completion Summary:
┌─────────────────────────────────────────────────────────────┐
│ สรุปงาน - บริษัท ABC จำกัด (งาน PRC-2025-001)               │
│                                                             │
│ ┌─ สถานะสุดท้าย ─────────────────────────────────────────┐  │
│ │ สถานะงาน: ✅ ส่งสำเร็จแล้ว                              │  │
│ │ วันที่ส่งสำเร็จ: 23 ม.ค. 2568 15:30                     │  │
│ │ ผู้รับ: คุณสมชาย สมิท (เซ็นรับแล้ว)                     │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ ┌─ สรุปเอกสารทั้งหมด ────────────────────────────────────┐  │
│ │ 📋 ใบเสนอราคา: QT202501-0045 ✅ (15 ม.ค. 2568)        │  │
│ │ 💰 ใบแจ้งหนี้: INV202501-0123 ✅ (16 ม.ค. 2568)        │  │
│ │ 🧾 ใบเสร็จ/ใบกำกับ: RCPT202501-0089 ✅ (20 ม.ค. 2568) │  │
│ │ 📦 ใบส่งของ: DN202501-0056 ✅ (23 ม.ค. 2568)           │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ ┌─ สรุปการเงิน ──────────────────────────────────────────┐  │
│ │ ยอดรวมทั้งหมด: ฿53,500.00                              │  │
│ │ เงินมัดจำ: ฿26,750.00 (รับแล้ว)                        │  │
│ │ ยอดคงเหลือ: ฿26,750.00 (รับแล้ว)                       │  │
│ │ สถานะการชำระ: ✅ ชำระครบแล้ว                            │  │
│ │                                                         │  │
│ │ กำไรขาดทุน:                                             │  │
│ │ รายได้: ฿53,500.00                                      │  │
│ │ ต้นทุน: ฿35,000.00 (จากระบบ Pricing)                   │  │
│ │ กำไร: ฿18,500.00 (34.6%)                               │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ ┌─ การดำเนินการต่อ ──────────────────────────────────────┐  │
│ │ [📊 ดูรายงานสรุปงาน] [📧 ส่งรายงานให้ผู้จัดการ]          │  │
│ │ [🔄 สร้างงานติดตามหลังการขาย] [⭐ ประเมินความพึงพอใจ]    │  │
│ │ [📁 เก็บเอกสารเข้าระบบเก็บถาวร]                         │  │
│ └─────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### Delivery Status Flow
```
Delivery Status Progression:

preparing → shipping → in_transit → delivered → completed
    ↓         ↓          ↓           ↓          ↑
preparing → failed → returned → investigating → completed
                 ↓
               cancelled

Status Colors:
🟢 completed - ส่งสำเร็จ
🟡 in_transit - กำลังส่ง
🔵 preparing - เตรียมส่ง
🔴 failed - ส่งไม่สำเร็จ
⚫ cancelled - ยกเลิก
🟠 returned - ส่งคืน
```

---

## 🔄 การจัดการกรณีพิเศษ (Exception Handling) {#exceptions}

### 💡 กรณี 1: ลูกค้าเปลี่ยนใจเพิ่มสินค้า (หลังจ่ายมัดจำ)

### AI Command
```bash
สร้างระบบแก้ไขออเดอร์และคำนวณยอดใหม่ 
พร้อมออกเอกสาร Credit/Debit Note อัตโนมัติ
```

```
Order Modification Flow:
┌─────────────────────────────────────────────────────────────┐
│ 🔄 การแก้ไขออเดอร์ - QT202501-0045                          │
│                                                             │
│ สถานการณ์: ลูกค้าจ่ายมัดจำ 50% แล้ว ต้องการเพิ่มสินค้า      │
│                                                             │
│ ┌─ Step 1: ย้อนกลับสถานะ (Account เท่านั้น) ──────────────┐  │
│ │ สถานะปัจจุบัน: ใบแจ้งหนี้ (อนุมัติแล้ว)                  │  │
│ │ ต้องการย้อนกลับไป: ใบเสนอราคา (เพื่อแก้ไข)                │  │
│ │                                                         │  │
│ │ เหตุผลการย้อนกลับ:                                       │  │
│ │ [ลูกค้าต้องการเพิ่มรายการสินค้า - บริการติดตั้ง]           │  │
│ │                                                         │  │
│ │ ⚠️ คำเตือน: การย้อนกลับจะส่งผลกระทบต่อเอกสารที่เกี่ยวข้อง │  │
│ │ [❌ ยกเลิก] [✅ ยืนยันการย้อนกลับ]                        │  │
│ └─────────────────────────────────────────────────────────┘  │
│                           ↓                                   │
│ ┌─ Step 2: แก้ไขใบเสนอราคา ─────────────────────────────┐  │
│ │ รายการเดิม:                                             │  │
│ │ • งานพิมพ์โบรชัวร์ A4 (2 ชิ้น × ฿25,000) = ฿50,000     │  │
│ │                                                         │  │
│ │ รายการเพิ่ม:                                            │  │
│ │ [+ เพิ่มรายการใหม่]                                     │  │
│ │ • บริการติดตั้ง (1 วัน × ฿5,000) = ฿5,000               │  │
│ │                                                         │  │
│ │ การคำนวณใหม่:                                           │  │
│ │ ยอดเดิม: ฿53,500.00                                    │  │
│ │ ยอดเพิ่ม: ฿5,350.00 (รวม VAT)                          │  │
│ │ ยอดใหม่: ฿58,850.00                                    │  │
│ │                                                         │  │
│ │ การคำนวณเงินมัดจำ:                                      │  │
│ │ เงินมัดจำเดิม: -฿26,750.00 (50% ของยอดเดิม)            │  │
│ │ ยอดเพิ่มที่ต้องชำระ: ฿5,350.00                          │  │
│ │ ยอดคงเหลือใหม่: ฿32,100.00                             │  │
│ │                                                         │  │
│ │ [บันทึกการแก้ไข] [ส่งตรวจสอบใหม่]                        │  │
│ └─────────────────────────────────────────────────────────┘  │
│                           ↓                                   │
│ ┌─ Step 3: ออกเอกสารปรับยอด ────────────────────────────┐  │
│ │ ระบบสร้างอัตโนมัติ:                                     │  │
│ │                                                         │  │
│ │ 📄 ใบเพิ่มหนี้ (Debit Note): DB202501-001              │  │
│ │    อ้างอิง: QT202501-0045 (ใบเสนอราคาเดิม)             │  │
│ │    ยอดเพิ่ม: ฿5,350.00                                 │  │
│ │    เหตุผล: เพิ่มบริการติดตั้งตามคำขอลูกค้า               │  │
│ │                                                         │  │
│ │ 💰 ใบแจ้งหนี้ใหม่: INV202501-0124                      │  │
│ │    ยอดคงเหลือ: ฿32,100.00                             │  │
│ │    ครบกำหนด: 15 ก.พ. 2568                             │  │
│ │                                                         │  │
│ │ [สร้างเอกสารปรับยอด] [ส่งแจ้งลูกค้า]                    │  │
│ └─────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 📦 กรณี 2: ส่งสินค้าไม่ครบ (Partial Delivery)

### AI Command
```bash
สร้างระบบจัดการส่งสินค้าแบบงวด 
พร้อมติดตามจำนวนคงเหลือและออกเอกสารแยกตามงวด
```

```
Partial Delivery Management:
┌─────────────────────────────────────────────────────────────┐
│ 📦 การส่งสินค้าบางส่วน - โบรชัวร์ A4                         │
│                                                             │
│ สถานการณ์: สั่ง 1000 ชิ้น แต่ผลิตได้แค่ 600 ชิ้น            │
│                                                             │
│ ┌─ ข้อมูลออเดอร์ ────────────────────────────────────────┐  │
│ │ รายการ: โบรชัวร์ A4 4 สี                               │  │
│ │ จำนวนสั่ง: 1000 ชิ้น × ฿60 = ฿60,000                  │  │
│ │ ผลิตเสร็จ: 600 ชิ้น                                    │  │
│ │ คงเหลือ: 400 ชิ้น                                      │  │
│ │ กำหนดส่งครบ: 15 ก.พ. 2568                             │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ ┌─ ตัวเลือกการออกบิล ────────────────────────────────────┐  │
│ │ เลือกวิธีการคิดเงิน:                                    │  │
│ │ ● คิดเงินตามที่ส่ง (แนะนำ)                              │  │
│ │   - งวดที่ 1: 600 ชิ้น × ฿60 = ฿36,000                │  │
│ │   - งวดที่ 2: 400 ชิ้น × ฿60 = ฿24,000 (รอส่ง)        │  │
│ │                                                         │  │
│ │ ○ คิดเงินเต็มจำนวน                                      │  │
│ │   - ใบแจ้งหนี้เต็มจำนวน: ฿60,000                       │  │
│ │   - ระบุการส่งเป็นงวดในหมายเหตุ                        │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ ┌─ การสร้างเอกสารงวดที่ 1 ───────────────────────────────┐  │
│ │ สร้างอัตโนมัติ:                                         │  │
│ │ 📦 ใบส่งของงวดที่ 1: DN202501-0060                     │  │
│ │    จำนวน: 600 ชิ้น (60% ของ order)                    │  │
│ │    หมายเหตุ: งวดที่ 1 จาก 2 งวด, คงเหลือ 400 ชิ้น      │  │
│ │                                                         │  │
│ │ 💰 ใบแจ้งหนี้งวดที่ 1: INV202501-0130                  │  │
│ │    ยอดเงิน: ฿36,000.00 (600 ชิ้น)                      │  │
│ │                                                         │  │
│ │ 🧾 ใบเสร็จงวดที่ 1: RCPT202501-0095                    │  │
│ │    (เมื่อลูกค้าชำระเงิน)                                │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ ┌─ ระบบติดตามคงเหลือ ────────────────────────────────────┐  │
│ │ 📊 Order Tracking Dashboard:                           │  │
│ │ ┌─────────────────────────────────────────────────────┐ │  │
│ │ │ Order ID: OR202501-001                              │ │  │
│ │ │ ├─ สั่งทั้งหมด: 1000 ชิ้น                           │ │  │
│ │ │ ├─ ส่งแล้ว: 600 ชิ้น (60%) ✅                       │ │  │
│ │ │ ├─ คงเหลือ: 400 ชิ้น (40%) 🟡                       │ │  │
│ │ │ └─ กำหนดส่ง: 15 ก.พ. 2568                           │ │  │
│ │ └─────────────────────────────────────────────────────┘ │  │
│ │                                                         │  │
│ │ สถานะ: 🟡 รอส่งงวดที่ 2                                │  │
│ │ [📅 นัดส่งงวดถัดไป] [📞 แจ้งลูกค้า] [📊 ดูรายงาน]       │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ ┌─ เมื่อผลิตครบ (งวดที่ 2) ──────────────────────────────┐  │
│ │ ระบบสร้างอัตโนมัติ:                                     │  │
│ │ 📦 ใบส่งของงวดที่ 2: DN202501-0061                     │  │
│ │ 💰 ใบแจ้งหนี้งวดที่ 2: INV202501-0131                  │  │
│ │ 🧾 ใบเสร็จงวดที่ 2: RCPT202501-0096                    │  │
│ │                                                         │  │
│ │ สถานะสุดท้าย: ✅ ส่งครบทุกงวดแล้ว                       │  │
│ │ [ปิดงาน] [ส่งรายงานสรุป]                                │  │
│ └─────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 🔄 กรณี 3: การคืนสินค้า

### AI Command
```bash
สร้างระบบจัดการการคืนสินค้าพร้อมออก Credit Note
และปรับปรุงสต็อก/การเงินอัตโนมัติ
```

```
Product Return Management:
┌─────────────────────────────────────────────────────────────┐
│ 🔄 การคืนสินค้า - โบรชัวร์ A4 (มีปัญหาคุณภาพ)              │
│                                                             │
│ ┌─ ข้อมูลการคืน ─────────────────────────────────────────┐  │
│ │ อ้างอิง: DN202501-0056 (ใบส่งของ)                      │  │
│ │ สินค้า: โบรชัวร์ A4 4 สี                               │  │
│ │ จำนวนคืน: 500 ชิ้น จาก 1000 ชิ้น                      │  │
│ │ เหตุผล: [พิมพ์ผิดสี ไม่ตรงตาม spec]                   │  │
│ │ วันที่คืน: 25 ม.ค. 2568                                │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ ┌─ การคำนวณเงินคืน ──────────────────────────────────────┐  │
│ │ ราคาต่อหน่วย: ฿60.00                                   │  │
│ │ จำนวนคืน: 500 ชิ้น                                     │  │
│ │ ยอดเงินคืน: ฿30,000.00                                 │  │
│ │ VAT ที่ต้องคืน: ฿1,963.00                              │  │
│ │ รวมเงินคืน: ฿31,963.00                                 │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ ┌─ เอกสารที่ออก ────────────────────────────────────────┐  │
│ │ ระบบสร้างอัตโนมัติ:                                     │  │
│ │                                                         │  │
│ │ 📄 ใบลดหนี้ (Credit Note): CR202501-001               │  │
│ │    อ้างอิง: INV202501-0130 (ใบแจ้งหนี้เดิม)            │  │
│ │    ยอดลด: ฿31,963.00                                   │  │
│ │    เหตุผล: คืนสินค้าเนื่องจากไม่ตรงคุณภาพ               │  │
│ │                                                         │  │
│ │ 📋 ใบรับคืนสินค้า: RET202501-001                       │  │
│ │    สถานะสินค้า: [❌ ทำลาย] [🔄 ผลิตใหม่] [📦 เก็บ]      │  │
│ │                                                         │  │
│ │ 💰 ใบสำคัญจ่าย (หรือหักยอดค้างชำระ)                    │  │
│ │    จำนวน: ฿31,963.00                                   │  │
│ └─────────────────────────────────────────────────────────┘  │
│                                                             │
│ ┌─ การปรับปรุงระบบ ──────────────────────────────────────┐  │
│ │ อัปเดตอัตโนมัติ:                                        │  │
│ │ • ปรับสต็อกสินค้า (+500 ชิ้น หรือ -500 ชิ้นเสีย)        │  │
│ │ • ปรับยอดขาย (-฿31,963.00)                             │  │
│ │ • อัปเดตสถานะลูกค้า (ถ้ามียอดค้างชำระ)                  │  │
│ │ • บันทึกประวัติการคืนสินค้า                            │  │
│ │                                                         │  │
│ │ [บันทึกการคืนสินค้า] [พิมพ์เอกสาร] [แจ้งฝ่ายผลิต]        │  │
│ └─────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔧 Technical Implementation {#technical}

### Database Schema

```sql
-- ตารางหลักสำหรับเอกสารแต่ละประเภท
CREATE TABLE quotations (
  id SERIAL PRIMARY KEY,
  number VARCHAR(50) UNIQUE NOT NULL,
  pricing_job_id INT REFERENCES pricing_jobs(id),
  customer_id INT REFERENCES customers(id),
  status ENUM('draft', 'pending_review', 'approved', 'rejected', 'sent', 'completed') DEFAULT 'draft',
  subtotal DECIMAL(15,2) NOT NULL,
  tax_amount DECIMAL(15,2) DEFAULT 0,
  total_amount DECIMAL(15,2) NOT NULL,
  deposit_percentage INT DEFAULT 0,
  deposit_amount DECIMAL(15,2) DEFAULT 0,
  payment_terms VARCHAR(50),
  due_date DATE,
  notes TEXT,
  created_by INT REFERENCES users(id),
  approved_by INT REFERENCES users(id),
  approved_at TIMESTAMP NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE invoices (
  id SERIAL PRIMARY KEY,
  number VARCHAR(50) UNIQUE NOT NULL,
  quotation_id INT REFERENCES quotations(id),
  customer_id INT REFERENCES customers(id),
  status ENUM('draft', 'pending', 'approved', 'sent', 'partial_paid', 'fully_paid', 'overdue') DEFAULT 'draft',
  subtotal DECIMAL(15,2) NOT NULL,
  tax_amount DECIMAL(15,2) DEFAULT 0,
  total_amount DECIMAL(15,2) NOT NULL,
  paid_amount DECIMAL(15,2) DEFAULT 0,
  due_date DATE,
  payment_method VARCHAR(50),
  created_by INT REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE receipts (
  id SERIAL PRIMARY KEY,
  number VARCHAR(50) UNIQUE NOT NULL,
  invoice_id INT REFERENCES invoices(id),
  customer_id INT REFERENCES customers(id),
  type ENUM('receipt', 'tax_invoice', 'full_tax_invoice') DEFAULT 'receipt',
  status ENUM('draft', 'approved', 'sent') DEFAULT 'draft',
  subtotal DECIMAL(15,2) NOT NULL,
  tax_amount DECIMAL(15,2) DEFAULT 0,
  total_amount DECIMAL(15,2) NOT NULL,
  payment_method VARCHAR(50),
  payment_reference VARCHAR(100),
  tax_invoice_number VARCHAR(50),
  issued_by INT REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE delivery_notes (
  id SERIAL PRIMARY KEY,
  number VARCHAR(50) UNIQUE NOT NULL,
  receipt_id INT REFERENCES receipts(id),
  customer_id INT REFERENCES customers(id),
  status ENUM('preparing', 'shipping', 'in_transit', 'delivered', 'completed', 'failed') DEFAULT 'preparing',
  delivery_method ENUM('self_delivery', 'courier', 'customer_pickup') DEFAULT 'courier',
  courier_company VARCHAR(100),
  tracking_number VARCHAR(100),
  delivery_address TEXT,
  recipient_name VARCHAR(255),
  recipient_phone VARCHAR(50),
  delivery_date DATE,
  delivered_at TIMESTAMP NULL,
  created_by INT REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- ตารางสำหรับติดตามการเปลี่ยนแปลงสถานะ
CREATE TABLE document_history (
  id SERIAL PRIMARY KEY,
  document_type ENUM('quotation', 'invoice', 'receipt', 'delivery_note', 'credit_note', 'debit_note'),
  document_id INT NOT NULL,
  previous_status VARCHAR(50),
  new_status VARCHAR(50),
  action VARCHAR(100),
  notes TEXT,
  action_by INT REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW()
);

-- ตารางสำหรับติดตามจำนวนคงเหลือ
CREATE TABLE order_items_tracking (
  id SERIAL PRIMARY KEY,
  quotation_id INT REFERENCES quotations(id),
  product_id INT REFERENCES products(id),
  ordered_quantity INT NOT NULL,
  delivered_quantity INT DEFAULT 0,
  remaining_quantity INT GENERATED ALWAYS AS (ordered_quantity - delivered_quantity) STORED,
  returned_quantity INT DEFAULT 0,
  unit_price DECIMAL(10,2) NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- ตารางสำหรับเก็บไฟล์แนบ
CREATE TABLE document_attachments (
  id SERIAL PRIMARY KEY,
  document_type ENUM('quotation', 'invoice', 'receipt', 'delivery_note'),
  document_id INT NOT NULL,
  filename VARCHAR(255) NOT NULL,
  original_filename VARCHAR(255) NOT NULL,
  file_path VARCHAR(500) NOT NULL,
  file_size INT,
  mime_type VARCHAR(100),
  uploaded_by INT REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW()
);
```

### API Endpoints Structure

```javascript
// RESTful API Design
const API_ENDPOINTS = {
  // Authentication
  auth: {
    login: 'POST /api/auth/login',
    logout: 'POST /api/auth/logout',
    me: 'GET /api/auth/me'
  },

  // Pricing Integration
  pricing: {
    getCompletedJobs: 'GET /api/pricing/completed-jobs',
    getJobDetail: 'GET /api/pricing/jobs/:id',
    markAsUsed: 'POST /api/pricing/jobs/:id/mark-used'
  },

  // Quotations
  quotations: {
    list: 'GET /api/quotations',
    create: 'POST /api/quotations',
    show: 'GET /api/quotations/:id',
    update: 'PUT /api/quotations/:id',
    delete: 'DELETE /api/quotations/:id',
    
    // Actions
    submit: 'POST /api/quotations/:id/submit',
    approve: 'POST /api/quotations/:id/approve',
    reject: 'POST /api/quotations/:id/reject',
    rollback: 'POST /api/quotations/:id/rollback',
    
    // Conversions
    convertToInvoice: 'POST /api/quotations/:id/convert-to-invoice',
    
    // File operations
    generatePDF: 'GET /api/quotations/:id/pdf',
    sendEmail: 'POST /api/quotations/:id/send-email',
    uploadEvidence: 'POST /api/quotations/:id/upload-evidence'
  },

  // Invoices
  invoices: {
    list: 'GET /api/invoices',
    create: 'POST /api/invoices',
    show: 'GET /api/invoices/:id',
    update: 'PUT /api/invoices/:id',
    
    // Payment
    recordPayment: 'POST /api/invoices/:id/payments',
    getPaymentHistory: 'GET /api/invoices/:id/payments',
    
    // Conversions
    convertToReceipt: 'POST /api/invoices/:id/convert-to-receipt',
    
    // Tracking
    sendReminder: 'POST /api/invoices/:id/send-reminder',
    updateStatus: 'PUT /api/invoices/:id/status'
  },

  // Receipts
  receipts: {
    list: 'GET /api/receipts',
    create: 'POST /api/receipts',
    show: 'GET /api/receipts/:id',
    approve: 'POST /api/receipts/:id/approve',
    generateTaxNumber: 'POST /api/receipts/:id/generate-tax-number',
    convertToDeliveryNote: 'POST /api/receipts/:id/convert-to-delivery-note'
  },

  // Delivery Notes
  deliveryNotes: {
    list: 'GET /api/delivery-notes',
    create: 'POST /api/delivery-notes',
    show: 'GET /api/delivery-notes/:id',
    updateStatus: 'PUT /api/delivery-notes/:id/status',
    updateTracking: 'PUT /api/delivery-notes/:id/tracking',
    markDelivered: 'POST /api/delivery-notes/:id/mark-delivered'
  },

  // Exception Handling
  adjustments: {
    createDebitNote: 'POST /api/adjustments/debit-notes',
    createCreditNote: 'POST /api/adjustments/credit-notes',
    processReturn: 'POST /api/adjustments/returns'
  },

  // Reports
  reports: {
    dashboard: 'GET /api/reports/dashboard',
    sales: 'GET /api/reports/sales',
    payments: 'GET /api/reports/payments',
    delivery: 'GET /api/reports/delivery'
  }
};
```

### State Management (Zustand)

```javascript
// Document Flow Store
const useDocumentFlowStore = create((set, get) => ({
  // State
  currentDocument: null,
  documentList: [],
  filters: {
    status: 'all',
    dateRange: null,
    customer: null,
    documentType: 'quotation'
  },
  
  // Actions
  setCurrentDocument: (doc) => set({ currentDocument: doc }),
  
  // Document Flow Actions
  submitForReview: async (documentId) => {
    try {
      const response = await documentApi.submit(documentId);
      
      // Add to history
      await get().addToHistory(documentId, 'quotation', 'submit', 'ส่งตรวจสอบ');
      
      // Update local state
      set((state) => ({
        documentList: state.documentList.map(doc => 
          doc.id === documentId 
            ? { ...doc, status: 'pending_review' }
            : doc
        )
      }));
      
      return response;
    } catch (error) {
      throw error;
    }
  },
  
  approveDocument: async (documentId, notes) => {
    try {
      const response = await documentApi.approve(documentId, notes);
      
      await get().addToHistory(documentId, 'quotation', 'approve', notes);
      
      set((state) => ({
        documentList: state.documentList.map(doc => 
          doc.id === documentId 
            ? { ...doc, status: 'approved', approved_by: getCurrentUser().id }
            : doc
        )
      }));
      
      return response;
    } catch (error) {
      throw error;
    }
  },
  
  // One-Click Conversions
  convertToInvoice: async (quotationId, options) => {
    try {
      const invoice = await quotationApi.convertToInvoice(quotationId, options);
      
      // Update quotation status
      set((state) => ({
        documentList: state.documentList.map(doc => 
          doc.id === quotationId 
            ? { ...doc, status: 'converted', invoice_id: invoice.id }
            : doc
        )
      }));
      
      await get().addToHistory(quotationId, 'quotation', 'convert_to_invoice', 
        `แปลงเป็นใบแจ้งหนี้ ${invoice.number}`);
      
      return invoice;
    } catch (error) {
      throw error;
    }
  },
  
  convertToReceipt: async (invoiceId, paymentData) => {
    try {
      // Record payment first
      await invoiceApi.recordPayment(invoiceId, paymentData);
      
      // Convert to receipt
      const receipt = await invoiceApi.convertToReceipt(invoiceId);
      
      await get().addToHistory(invoiceId, 'invoice', 'convert_to_receipt',
        `สร้างใบเสร็จ ${receipt.number}`);
      
      return receipt;
    } catch (error) {
      throw error;
    }
  },
  
  // Exception Handling
  rollbackDocument: async (documentId, documentType, reason) => {
    try {
      const response = await documentApi.rollback(documentId, documentType, reason);
      
      await get().addToHistory(documentId, documentType, 'rollback', reason);
      
      // Update status based on rollback rules
      const newStatus = get().calculateRollbackStatus(documentType);
      set((state) => ({
        documentList: state.documentList.map(doc => 
          doc.id === documentId 
            ? { ...doc, status: newStatus }
            : doc
        )
      }));
      
      return response;
    } catch (error) {
      throw error;
    }
  },
  
  // Utility functions
  addToHistory: async (documentId, documentType, action, notes) => {
    try {
      await documentApi.addHistory({
        document_id: documentId,
        document_type: documentType,
        action,
        notes,
        action_by: getCurrentUser().id
      });
    } catch (error) {
      console.error('Failed to add history:', error);
    }
  },
  
  calculateRollbackStatus: (documentType) => {
    const rollbackMap = {
      'invoice': 'approved',     // ย้อนจากใบแจ้งหนี้ไปใบเสนอราคาที่อนุมัติแล้ว
      'receipt': 'approved',     // ย้อนจากใบเสร็จไปใบแจ้งหนี้ที่อนุมัติแล้ว
      'delivery_note': 'approved' // ย้อนจากใบส่งของไปใบเสร็จที่อนุมัติแล้ว
    };
    return rollbackMap[documentType] || 'draft';
  },
  
  // Get available actions based on role and status
  getAvailableActions: (document) => {
    const userRole = useAuthStore.getState().user.role;
    const { status, document_type } = document;
    
    return getAvailableActionsByRole(document_type, status, userRole);
  }
}));

// Permission Store
const usePermissionStore = create((set, get) => ({
  permissions: {},
  
  hasPermission: (resource, action, document = null) => {
    const userRole = useAuthStore.getState().user.role;
    return hasPermission(userRole, resource, action, document);
  },
  
  canEdit: (document) => {
    const userRole = useAuthStore.getState().user.role;
    
    if (userRole === 'account') return true; // Account แก้ไขได้หมด
    
    if (userRole === 'sales') {
      // Sales แก้ไขได้เฉพาะที่ตัวเองสร้างและสถานะ draft
      return document.created_by === getCurrentUser().id && 
             document.status === 'draft';
    }
    
    return false;
  },
  
  canApprove: (document) => {
    const userRole = useAuthStore.getState().user.role;
    return userRole === 'account' && 
           ['pending_review', 'draft'].includes(document.status);
  },
  
  canRollback: (document) => {
    const userRole = useAuthStore.getState().user.role;
    return userRole === 'account' && 
           !['draft', 'rejected'].includes(document.status);
  }
}));
```

### Role-Based Permission System

```javascript
// Permission Matrix
const PERMISSIONS = {
  quotations: {
    sales: {
      create: true,
      read: 'own',        // เฉพาะที่ตัวเองสร้าง
      update: 'own_draft', // เฉพาะร่างที่ตัวเองสร้าง
      delete: 'own_draft',
      submit: 'own',
      approve: false,
      reject: false,
      rollback: false,
      convert: false
    },
    account: {
      create: true,
      read: true,         // ทั้งหมด
      update: true,       // ทั้งหมด
      delete: true,
      submit: true,
      approve: true,
      reject: true,
      rollback: true,
      convert: true
    }
  },
  
  invoices: {
    sales: {
      create: false,      // สร้างได้เฉพาะผ่าน conversion
      read: 'related',    // ที่เกี่ยวข้องกับใบเสนอราคาตัวเอง
      update: false,
      recordPayment: false,
      approve: false,
      convert: false
    },
    account: {
      create: true,
      read: true,
      update: true,
      recordPayment: true,
      approve: true,
      convert: true,
      rollback: true
    }
  },
  
  receipts: {
    sales: {
      create: false,
      read: 'related',
      update: false,
      approve: false
    },
    account: {
      create: true,
      read: true,
      update: true,
      approve: true,
      generateTaxNumber: true,
      convert: true
    }
  },
  
  deliveryNotes: {
    sales: {
      create: false,
      read: 'related',
      update: 'status_only', // อัปเดตสถานะได้บางอย่าง
      markDelivered: 'related'
    },
    account: {
      create: true,
      read: true,
      update: true,
      markDelivered: true,
      rollback: true
    }
  }
};

// Permission Check Function
const hasPermission = (userRole, resource, action, document = null) => {
  const permission = PERMISSIONS[resource]?.[userRole]?.[action];
  
  if (permission === true) return true;
  if (permission === false) return false;
  
  // Special permission cases
  if (permission === 'own' && document) {
    return document.created_by === getCurrentUser().id;
  }
  
  if (permission === 'own_draft' && document) {
    return document.created_by === getCurrentUser().id && 
           document.status === 'draft';
  }
  
  if (permission === 'related' && document) {
    // ตรวจสอบว่าเอกสารนี้เกี่ยวข้องกับงานของ Sales หรือไม่
    return isRelatedToUser(document, getCurrentUser().id);
  }
  
  return false;
};

// Check if document is related to user (Sales)
const isRelatedToUser = (document, userId) => {
  // ตรวจสอบผ่าน quotation_id ย้อนกลับไป
  if (document.quotation_id) {
    // ดึงข้อมูล quotation เพื่อดูว่าใครเป็นคนสร้าง
    const quotation = getQuotationById(document.quotation_id);
    return quotation?.created_by === userId;
  }
  
  // หรือตรวจสอบจาก created_by ตรงๆ
  return document.created_by === userId;
};

// Get available actions for UI
const getAvailableActionsByRole = (documentType, status, userRole) => {
  const actionsMap = {
    quotation: {
      draft: {
        sales: ['edit', 'delete', 'submit_for_review'],
        account: ['edit', 'delete', 'approve', 'reject']
      },
      pending_review: {
        sales: ['view'],
        account: ['approve', 'reject', 'send_back_for_edit']
      },
      approved: {
        sales: ['view', 'download_pdf', 'send_email', 'upload_evidence'],
        account: ['view', 'edit', 'revoke_approval', 'convert_to_invoice']
      },
      sent: {
        sales: ['view', 'mark_completed'],
        account: ['view', 'convert_to_invoice']
      },
      completed: {
        sales: ['view'],
        account: ['view', 'convert_to_invoice']
      }
    },
    
    invoice: {
      draft: {
        sales: ['view'],
        account: ['edit', 'delete', 'approve']
      },
      approved: {
        sales: ['view'],
        account: ['view', 'send_email', 'record_payment', 'rollback']
      },
      sent: {
        sales: ['view'],
        account: ['view', 'record_payment', 'send_reminder']
      },
      partial_paid: {
        sales: ['view'],
        account: ['view', 'record_payment', 'convert_to_receipt']
      },
      fully_paid: {
        sales: ['view'],
        account: ['view', 'convert_to_receipt']
      }
    },
    
    receipt: {
      draft: {
        sales: ['view'],
        account: ['edit', 'approve', 'delete']
      },
      approved: {
        sales: ['view'],
        account: ['view', 'download_pdf', 'convert_to_delivery_note']
      }
    },
    
    delivery_note: {
      preparing: {
        sales: ['view'],
        account: ['view', 'edit', 'mark_shipped']
      },
      shipping: {
        sales: ['view', 'update_tracking'],
        account: ['view', 'update_tracking', 'mark_delivered']
      },
      delivered: {
        sales: ['view', 'mark_completed'],
        account: ['view', 'mark_completed']
      }
    }
  };
  
  return actionsMap[documentType]?.[status]?.[userRole] || [];
};
```

### Exception Handling Functions

```javascript
// Order Modification (เพิ่มสินค้าหลังจ่ายมัดจำ)
const handleOrderModification = async (quotationId, newItems, reason) => {
  try {
    // 1. Rollback to quotation
    await documentApi.rollback(quotationId, 'quotation', reason);
    
    // 2. Update quotation with new items
    const originalQuotation = await quotationApi.getById(quotationId);
    const updatedData = {
      ...originalQuotation,
      items: [...originalQuotation.items, ...newItems]
    };
    
    // Recalculate totals
    const newSubtotal = calculateSubtotal(updatedData.items);
    const newTaxAmount = calculateTax(newSubtotal);
    const newTotal = newSubtotal + newTaxAmount;
    
    updatedData.subtotal = newSubtotal;
    updatedData.tax_amount = newTaxAmount;
    updatedData.total_amount = newTotal;
    
    // Calculate new deposit and remaining
    const depositAmount = originalQuotation.deposit_amount; // เงินมัดจำเดิม
    const additionalAmount = newTotal - originalQuotation.total_amount;
    const newRemainingAmount = newTotal - depositAmount;
    
    await quotationApi.update(quotationId, updatedData);
    
    // 3. Create Debit Note for additional amount
    if (additionalAmount > 0) {
      const debitNote = await adjustmentApi.createDebitNote({
        reference_type: 'quotation',
        reference_id: quotationId,
        amount: additionalAmount,
        reason: `เพิ่มรายการสินค้าตามคำขอลูกค้า: ${reason}`,
        created_by: getCurrentUser().id
      });
    }
    
    // 4. Re-submit for approval
    await documentApi.submit(quotationId);
    
    return {
      quotation: updatedData,
      additionalAmount,
      newRemainingAmount
    };
    
  } catch (error) {
    throw error;
  }
};

// Partial Delivery Handling
const handlePartialDelivery = async (orderId, deliveredItems) => {
  try {
    // 1. Create partial delivery note
    const deliveryNote = await deliveryNoteApi.create({
      order_id: orderId,
      items: deliveredItems,
      delivery_type: 'partial',
      notes: `การส่งสินค้าบางส่วน งวดที่ ${getDeliverySequence(orderId)}`
    });
    
    // 2. Update order tracking
    for (const item of deliveredItems) {
      await orderTrackingApi.updateDelivered(orderId, item.product_id, item.quantity);
    }
    
    // 3. Create invoice for delivered items
    const partialInvoice = await invoiceApi.createPartial({
      order_id: orderId,
      items: deliveredItems,
      delivery_note_id: deliveryNote.id
    });
    
    // 4. Check if order is complete
    const remainingItems = await orderTrackingApi.getRemainingItems(orderId);
    const isComplete = remainingItems.every(item => item.remaining_quantity === 0);
    
    if (isComplete) {
      await orderApi.markComplete(orderId);
    }
    
    return {
      deliveryNote,
      partialInvoice,
      remainingItems,
      isComplete
    };
    
  } catch (error) {
    throw error;
  }
};

// Product Return Handling
const handleProductReturn = async (deliveryNoteId, returnItems, reason) => {
  try {
    // 1. Create return note
    const returnNote = await returnApi.create({
      delivery_note_id: deliveryNoteId,
      items: returnItems,
      reason,
      return_date: new Date(),
      created_by: getCurrentUser().id
    });
    
    // 2. Calculate refund amount
    const refundAmount = calculateRefundAmount(returnItems);
    
    // 3. Create credit note
    const creditNote = await adjustmentApi.createCreditNote({
      reference_type: 'delivery_note',
      reference_id: deliveryNoteId,
      amount: refundAmount,
      reason: `คืนสินค้า: ${reason}`,
      created_by: getCurrentUser().id
    });
    
    // 4. Update inventory
    for (const item of returnItems) {
      await inventoryApi.updateStock(item.product_id, item.quantity, 'return');
    }
    
    // 5. Update customer balance (if applicable)
    const customer = await getCustomerFromDeliveryNote(deliveryNoteId);
    if (customer.outstanding_balance > 0) {
      await customerApi.updateBalance(customer.id, -refundAmount);
    }
    
    return {
      returnNote,
      creditNote,
      refundAmount
    };
    
  } catch (error) {
    throw error;
  }
};
```

---

## 🎯 คำสั่งสำหรับ AI Developer {#ai-commands}

### 🚀 Primary Commands

```bash
# 1. สร้าง Document Flow Engine
"สร้าง Document Flow Engine ที่จัดการ state transitions ตาม FlowAccount 
พร้อม role-based permissions และ audit trail"

# 2. สร้าง One-Click Conversion System
"สร้างระบบแปลงเอกสารแบบ one-click จากใบเสนอราคา → ใบแจ้งหนี้ → ใบเสร็จ → ใบส่งของ
พร้อมการดึงข้อมูลอัตโนมัติและคำนวณยอดเงิน"

# 3. สร้าง Role-Based UI System
"สร้าง UI ที่แสดงปุ่มและฟังก์ชันต่างกันตาม role Sales และ Account
พร้อม permission checking และ action availability"

# 4. สร้าง Auto Calculation Engine
"สร้างระบบคำนวณ VAT, เงินมัดจำ, ยอดคงเหลือ และการแยกภาษีแบบอัตโนมัติ
ตามมาตรฐาน FlowAccount"

# 5. สร้าง Status Tracking System
"สร้างระบบติดตามสถานะเอกสารแบบ real-time พร้อม timeline และประวัติการเปลี่ยนแปลง"

# 6. สร้าง Exception Handling Module
"สร้างระบบจัดการกรณีพิเศษ: แก้ไขออเดอร์, ส่งสินค้าไม่ครบ, การคืนสินค้า
พร้อม Credit/Debit Note อัตโนมัติ"

# 7. สร้าง Integration API
"สร้าง API เชื่อมต่อกับระบบ Pricing และระบบขนส่ง 
พร้อม error handling และ retry mechanism"

# 8. สร้าง Notification System
"สร้างระบบแจ้งเตือนอัตโนมัติสำหรับเอกสารรอการอนุมัติ, 
การครบกำหนดชำระ และสถานะการส่งสินค้า"
```

### 🎨 UI/UX Commands

```bash
# 9. สร้าง Dashboard แบบ Role-Based
"สร้าง Dashboard ที่แสดงข้อมูลต่างกันตาม role 
Sales เห็นงานของตัวเอง, Account เห็นทั้งหมด"

# 10. สร้าง Document List ที่มี Advanced Filter
"สร้างหน้ารายการเอกสารพร้อม filter, search, bulk actions 
และ status-based tabs"

# 11. สร้าง Multi-Step Forms
"สร้างฟอร์มสร้างเอกสารแบบ step-by-step พร้อม validation 
และ auto-save functionality"

# 12. สร้าง Timeline UI Component
"สร้าง component แสดง timeline การเปลี่ยนสถานะเอกสาร
พร้อม user actions และ timestamps"

# 13. สร้าง Mobile-Responsive Design
"สร้าง responsive design สำหรับ mobile ที่ใช้งานได้เต็มประสิทธิภาพ
พร้อม touch-friendly interface"
```

### 🔧 Technical Commands

```bash
# 14. สร้าง Database Schema
"สร้าง database schema ตาม ERD ที่กำหนด 
พร้อม indexes, constraints และ audit tables"

# 15. สร้าง API Endpoints
"สร้าง RESTful API endpoints ตาม specification 
พร้อม authentication, authorization และ rate limiting"

# 16. สร้าง State Management
"สร้าง Zustand stores สำหรับจัดการ state การทำงานของ documents
พร้อม persistence และ sync mechanism"

# 17. สร้าง Validation Layer
"สร้าง validation layer สำหรับ forms และ API requests
พร้อม custom rules และ error messages ภาษาไทย"

# 18. สร้าง PDF Generation System
"สร้างระบบสร้าง PDF templates สำหรับเอกสารแต่ละประเภท
พร้อม dynamic data binding และ formatting"
```

### 📊 Advanced Features Commands

```bash
# 19. สร้าง Reporting Dashboard
"สร้าง reporting dashboard พร้อม charts, KPIs 
และ export functionality (PDF/Excel)"

# 20. สร้าง Email Integration
"สร้างระบบส่งอีเมลอัตโนมัติพร้อม templates, attachments 
และ delivery tracking"

# 21. สร้าง File Upload System
"สร้างระบบอัปโหลดไฟล์แนบพร้อม preview, compression 
และ virus scanning"

# 22. สร้าง Audit Trail System
"สร้างระบบบันทึกการเปลี่ยนแปลงทั้งหมดพร้อม user tracking
และ rollback functionality"

# 23. สร้าง Backup & Recovery
"สร้างระบบ backup อัตโนมัติและ recovery procedures
พร้อม data integrity checks"
```

---

## 📈 Performance & Optimization

### 🚀 Performance Guidelines

```javascript
// 1. Database Optimization
const DB_OPTIMIZATION = {
  indexes: [
    'CREATE INDEX idx_quotations_status ON quotations(status)',
    'CREATE INDEX idx_quotations_customer ON quotations(customer_id)',
    'CREATE INDEX idx_quotations_created_date ON quotations(created_at)',
    'CREATE INDEX idx_invoices_due_date ON invoices(due_date)',
    'CREATE INDEX idx_document_history_document ON document_history(document_type, document_id)'
  ],
  
  // Connection Pooling
  connectionPool: {
    min: 5,
    max: 20,
    idle: 10000
  },
  
  // Query Optimization
  useSelectFields: true, // ไม่ใช้ SELECT *
  usePagination: true,   // แบ่งหน้าเสมอ
  cacheQueries: true     // Cache queries ที่ใช้บ่อย
};

// 2. Frontend Optimization
const FRONTEND_OPTIMIZATION = {
  // Code Splitting
  lazyLoading: [
    'DocumentForm',
    'ReportDashboard', 
    'AdvancedSearch'
  ],
  
  // State Management
  stateOptimization: {
    persistOnlyRequired: true,
    useShallowEqual: true,
    debounceUserInputs: 300 // ms
  },
  
  // Caching Strategy
  caching: {
    documentList: '5m',    // 5 minutes
    customerList: '15m',   // 15 minutes
    productList: '30m',    // 30 minutes
    reports: '1h'          // 1 hour
  }
};

// 3. API Optimization
const API_OPTIMIZATION = {
  // Response Compression
  compression: true,
  
  // Rate Limiting
  rateLimit: {
    windowMs: 15 * 60 * 1000, // 15 minutes
    max: 100 // requests per window
  },
  
  // Response Optimization
  responseOptimization: {
    useETags: true,
    cacheHeaders: true,
    compressResponse: true
  }
};
```

---

## 🔐 Security Considerations

```javascript
// Security Implementation
const SECURITY_MEASURES = {
  // Authentication
  authentication: {
    jwtExpiry: '24h',
    refreshTokenExpiry: '7d',
    bcryptRounds: 12,
    sessionTimeout: '4h'
  },
  
  // Authorization
  authorization: {
    roleBasedAccess: true,
    resourceLevelPermissions: true,
    documentOwnershipCheck: true
  },
  
  // Data Protection
  dataProtection: {
    encryptSensitiveData: true,
    auditTrail: true,
    dataRetention: '7 years',
    personalDataProtection: true
  },
  
  // API Security
  apiSecurity: {
    inputValidation: true,
    sqlInjectionPrevention: true,
    xssProtection: true,
    csrfProtection: true
  }
};
```

---

## 📚 Summary & Expected Results

### 🎯 ผลลัพธ์ที่คาดหวัง

ระบบ Account Management ที่:

✅ **ใช้งานง่ายเหมือน FlowAccount**
- แปลงเอกสารคลิกเดียว
- ดึงข้อมูลอัตโนมัติไม่ต้องพิมพ์ซ้ำ
- UI/UX ที่เข้าใจง่าย

✅ **รองรับ 2 Role อย่างชัดเจน**
- Sales: สร้าง แก้ไข ส่งตรวจสอบ
- Account: อนุมัติ ควบคุม จัดการการเงิน
- แต่ละคนมีหน้าที่และสิทธิ์ชัดเจน

✅ **จัดการกรณีพิเศษได้ยืดหยุ่น**
- แก้ไขออเดอร์หลังจ่ายมัดจำ
- ส่งสินค้าไม่ครบตามงวด
- การคืนสินค้า
- ออกเอกสารปรับยอด Credit/Debit Note

✅ **ติดตามได้ทุกขั้นตอน**
- Timeline แสดงประวัติการเปลี่ยนแปลง
- Status tracking แบบ real-time
- Audit trail ครบถ้วน

✅ **คำนวณอัตโนมัติ**
- VAT 7% ตามมาตรฐาน
- เงินมัดจำและยอดคงเหลือ
- การแยกภาษีย้อนกลับ

✅ **ปลอดภัยและเสถียร**
- Role-based permissions
- Data encryption
- Backup & recovery
- Performance optimization

### 🚀 Next Steps for Implementation

```markdown
Phase 1: Core Foundation (Week 1-2)
- Database schema setup
- Authentication & authorization
- Basic API endpoints
- Role-based UI components

Phase 2: Document Flow (Week 3-6)
- Quotation management
- Invoice creation & tracking
- Receipt/Tax invoice generation
- Delivery note system

Phase 3: Advanced Features (Week 7-9)
- One-click conversions
- Exception handling
- Notification system
- PDF generation

Phase 4: Integration & Testing (Week 10-12)
- Pricing system integration
- Courier API integration
- Performance optimization
- Security audit
- User acceptance testing

Phase 5: Deployment (Week 13-14)
- Production deployment
- Data migration
- User training
- Go-live support
```

---

**🎯 Final Goal**: ระบบบัญชีที่ทันสมัย ใช้งานง่าย มีประสิทธิภาพสูง และรองรับการเติบโตของธุรกิจ TNP Group พร้อมให้บริการลูกค้าได้อย่างมืออาชีพ

---

*สร้างโดย AI Assistant สำหรับ TNP Group - Document Version 1.0*