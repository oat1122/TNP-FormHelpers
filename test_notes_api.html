<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ TNP Notes API Tester</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .card { box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: none; }
        .card-header { background: linear-gradient(135deg, #900F0F 0%, #B20000 100%); color: white; }
        .btn-primary { background: linear-gradient(135deg, #900F0F 0%, #B20000 100%); border: none; }
        .btn-primary:hover { background: linear-gradient(135deg, #B20000 0%, #E36264 100%); }
        .note-sale { border-left: 4px solid #2196F3; background: rgba(33, 150, 243, 0.05); }
        .note-price { border-left: 4px solid #4CAF50; background: rgba(76, 175, 80, 0.05); }
        .badge-sale { background-color: #2196F3; }
        .badge-price { background-color: #4CAF50; }
        pre { background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; border: 1px solid #dee2e6; }
    </style>
</head>
<body>
    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-header text-center">
                        <h3>üß™ TNP Pricing Request Notes API Tester</h3>
                        <p class="mb-0">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö Notes ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö CreateQuotationForm</p>
                    </div>
                    <div class="card-body">
                        
                        <!-- API Configuration -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label">üåê API Base URL:</label>
                                <input type="text" id="baseUrl" class="form-control" 
                                       value="http://localhost:8000/api/v1" placeholder="API Base URL">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">üîë Auth Token (Optional):</label>
                                <input type="text" id="authToken" class="form-control" 
                                       placeholder="Bearer token ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£">
                            </div>
                        </div>

                        <!-- Step 1: Get Pricing Requests -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5>üìã Step 1: Get Pricing Requests</h5>
                            </div>
                            <div class="card-body">
                                <button class="btn btn-primary" onclick="getPricingRequests()">
                                    üîç Get Pricing Requests
                                </button>
                                <div id="pricingRequestsResult" class="mt-3"></div>
                            </div>
                        </div>

                        <!-- Step 2: Test Notes -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5>üìù Step 2: Test Notes API</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-8">
                                        <label class="form-label">üÜî Pricing Request ID:</label>
                                        <select id="prIdSelect" class="form-select">
                                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Pricing Request</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">&nbsp;</label>
                                        <button class="btn btn-primary d-block w-100" onclick="getNotes()">
                                            üìù Get Notes
                                        </button>
                                    </div>
                                </div>
                                <div id="notesResult" class="mt-3"></div>
                            </div>
                        </div>

                        <!-- Results -->
                        <div id="resultsContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let pricingRequestsData = [];

        async function makeRequest(url, options = {}) {
            const baseUrl = document.getElementById('baseUrl').value;
            const authToken = document.getElementById('authToken').value;
            
            const defaultOptions = {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            };

            if (authToken) {
                defaultOptions.headers['Authorization'] = `Bearer ${authToken}`;
            }

            try {
                const response = await fetch(url, { ...defaultOptions, ...options });
                const data = await response.json();
                
                return {
                    success: response.ok,
                    status: response.status,
                    data: data
                };
            } catch (error) {
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        async function getPricingRequests() {
            const baseUrl = document.getElementById('baseUrl').value;
            const resultDiv = document.getElementById('pricingRequestsResult');
            
            resultDiv.innerHTML = '<div class="alert alert-info">üîÑ Loading pricing requests...</div>';
            
            const result = await makeRequest(`${baseUrl}/pricing-requests`);
            
            if (result.success && result.data.success) {
                pricingRequestsData = result.data.data;
                
                // Populate select dropdown
                const select = document.getElementById('prIdSelect');
                select.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Pricing Request</option>';
                
                pricingRequestsData.forEach(pr => {
                    const option = document.createElement('option');
                    option.value = pr.pr_id;
                    option.textContent = `${pr.pr_work_name} (${pr.customer?.cus_company || 'N/A'})`;
                    select.appendChild(option);
                });
                
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        ‚úÖ Success! Found ${pricingRequestsData.length} pricing requests
                        <br><small>Total in DB: ${result.data.pagination?.total || 0}</small>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        ‚ùå Error: ${result.data?.message || result.error || 'Unknown error'}
                    </div>
                `;
            }
        }

        async function getNotes() {
            const baseUrl = document.getElementById('baseUrl').value;
            const prId = document.getElementById('prIdSelect').value;
            const resultDiv = document.getElementById('notesResult');
            
            if (!prId) {
                resultDiv.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è Please select a Pricing Request first</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="alert alert-info">üîÑ Loading notes...</div>';
            
            const result = await makeRequest(`${baseUrl}/pricing-requests/${prId}/notes`);
            
            if (result.success && result.data.success) {
                const notesData = result.data.data;
                
                let html = `
                    <div class="alert alert-success">
                        ‚úÖ Success! Found ${notesData.summary.total_notes} notes
                    </div>
                    
                    <!-- Summary -->
                    <div class="card mb-3">
                        <div class="card-header">üìä Summary</div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-4">
                                    <h4><span class="badge badge-sale">${notesData.summary.sale_count}</span></h4>
                                    <small>Sale Notes</small>
                                </div>
                                <div class="col-md-4">
                                    <h4><span class="badge badge-price">${notesData.summary.price_count}</span></h4>
                                    <small>Price Notes</small>
                                </div>
                                <div class="col-md-4">
                                    <h4><span class="badge bg-secondary">${notesData.summary.total_notes}</span></h4>
                                    <small>Total Notes</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Sale Notes
                if (notesData.sale_notes.length > 0) {
                    html += '<h5>üìû Sale Notes</h5>';
                    notesData.sale_notes.forEach(note => {
                        html += `
                            <div class="card note-sale mb-2">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <span class="badge badge-sale">Sale</span>
                                        <small class="text-muted">${note.formatted_date} by ${note.created_by_name}</small>
                                    </div>
                                    <div class="mt-2">
                                        <pre>${note.prn_text}</pre>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                // Price Notes
                if (notesData.price_notes.length > 0) {
                    html += '<h5>üí∞ Price Notes</h5>';
                    notesData.price_notes.forEach(note => {
                        html += `
                            <div class="card note-price mb-2">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <span class="badge badge-price">Price</span>
                                        <small class="text-muted">${note.formatted_date} by ${note.created_by_name}</small>
                                    </div>
                                    <div class="mt-2">
                                        <pre>${note.prn_text}</pre>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                if (notesData.summary.total_notes === 0) {
                    html += '<div class="alert alert-info">‚ÑπÔ∏è No notes found for this pricing request</div>';
                }
                
                resultDiv.innerHTML = html;
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        ‚ùå Error: ${result.data?.message || result.error || 'Unknown error'}
                    </div>
                `;
            }
        }

        // Auto-load pricing requests on page load
        document.addEventListener('DOMContentLoaded', function() {
            getPricingRequests();
        });
    </script>
</body>
</html>
