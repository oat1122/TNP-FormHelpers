# ЁЯУЛ р╕кр╕гр╕╕р╕Ыр╕Бр╕▓р╕гр╕Юр╕▒р╕Тр╕Щр╕▓: р╕кр╣Ир╕зр╕Щр╕ер╕Фр╕Юр╕┤р╣Ар╕ир╕йр╣Бр╕ер╕░р╕ар╕▓р╕йр╕╡р╕лр╕▒р╕Б р╕У р╕Чр╕╡р╣Ир╕Ир╣Ир╕▓р╕в

## ЁЯОп р╕Бр╕▓р╕гр╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╣Бр╕Ыр╕ер╕Зр╕лр╕ер╕▒р╕Б

### 1. тЬЕ Database Schema (Migration)
```sql
-- тЬЕ р╕гр╕▒р╕Щр╣Бр╕ер╣Йр╕з: 2025_08_21_120000_add_special_discount_and_withholding_tax_to_quotations
ALTER TABLE quotations ADD COLUMN special_discount_percentage DECIMAL(5,2) DEFAULT 0.00;
ALTER TABLE quotations ADD COLUMN special_discount_amount DECIMAL(15,2) DEFAULT 0.00;
ALTER TABLE quotations ADD COLUMN has_withholding_tax BOOLEAN DEFAULT FALSE;
ALTER TABLE quotations ADD COLUMN withholding_tax_percentage DECIMAL(5,2) DEFAULT 0.00;
ALTER TABLE quotations ADD COLUMN withholding_tax_amount DECIMAL(15,2) DEFAULT 0.00;
ALTER TABLE quotations ADD COLUMN final_total_amount DECIMAL(15,2) DEFAULT 0.00;
```

### 2. тЬЕ Backend Models & Controllers

#### Quotation Model (`Quotation.php`)
- тЬЕ р╣Ар╕Юр╕┤р╣Ир╕б fillable fields р╣Гр╕лр╕бр╣И
- тЬЕ р╣Ар╕Юр╕┤р╣Ир╕б casts р╕кр╕│р╕лр╕гр╕▒р╕Ъ data types
- тЬЕ р╣Ар╕Юр╕┤р╣Ир╕б accessor `getCalculatedWithholdingTaxAttribute()` 
- тЬЕ р╣Бр╕Бр╣Йр╣Др╕Вр╕Бр╕▓р╕гр╕Др╕│р╕Щр╕зр╕У: **р╕ар╕▓р╕йр╕╡р╕лр╕▒р╕Б р╕У р╕Чр╕╡р╣Ир╕Ир╣Ир╕▓р╕в = subtotal ├Ч р╕нр╕▒р╕Хр╕гр╕▓р╕ар╕▓р╕йр╕╡**

#### QuotationController (`QuotationController.php`)  
- тЬЕ р╣Ар╕Юр╕┤р╣Ир╕б validation rules р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Яр╕┤р╕ер╕Фр╣Мр╣Гр╕лр╕бр╣И
- тЬЕ р╕гр╕нр╕Зр╕гр╕▒р╕Ъ items discount percentage р╣Бр╕ер╕░ amount

### 3. тЬЕ Frontend Components

#### useQuotationCalc Hook
```javascript
// тЬЕ р╣Бр╕Бр╣Йр╣Др╕Вр╕Бр╕▓р╕гр╕Др╕│р╕Щр╕зр╕Ур╣Гр╕лр╣Йр╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З
const withholdingTaxAmount = hasWithholdingTax 
  ? subtotal * (Number(withholdingTaxPercentage || 0) / 100)  // тЬЕ р╕Др╕│р╕Щр╕зр╕Ур╕Ир╕▓р╕Б subtotal
  : 0;

const finalTotal = netAfterDiscount - withholdingTaxAmount;
```

#### CreateQuotationForm Component
- тЬЕ р╣Ар╕Юр╕┤р╣Ир╕б UI р╕кр╕│р╕лр╕гр╕▒р╕Ър╕кр╣Ир╕зр╕Щр╕ер╕Фр╕Юр╕┤р╣Ар╕ир╕й (р╣Ар╕Ыр╕нр╕гр╣Мр╣Ар╕Лр╣Зр╕Щр╕Хр╣М/р╕Ир╕│р╕Щр╕зр╕Щр╣Ар╕Зр╕┤р╕Щ)
- тЬЕ р╣Ар╕Юр╕┤р╣Ир╕б UI р╕кр╕│р╕лр╕гр╕▒р╕Ър╕ар╕▓р╕йр╕╡р╕лр╕▒р╕Б р╕У р╕Чр╕╡р╣Ир╕Ир╣Ир╕▓р╕в
- тЬЕ р╣Бр╕кр╕Фр╕Зр╕Бр╕▓р╕гр╕Др╕│р╕Щр╕зр╕Ур╣Бр╕Ър╕Ър╕ер╕░р╣Ар╕нр╕╡р╕вр╕Ф
- тЬЕ р╕нр╕▒р╕Ыр╣Ар╕Фр╕Х payload р╕Чр╕╡р╣Ир╕кр╣Ир╕Зр╣Др╕Ы backend

#### AccountingAPI
- тЬЕ р╣Ар╕Юр╕┤р╣Ир╕бр╕Яр╕┤р╕ер╕Фр╣Мр╣Гр╕лр╕бр╣Ир╣Гр╕Щ createQuotation payload
- тЬЕ р╕гр╕нр╕Зр╕гр╕▒р╕Ъ special discount р╣Бр╕ер╕░ withholding tax

## ЁЯзо р╕кр╕╣р╕Хр╕гр╕Бр╕▓р╕гр╕Др╕│р╕Щр╕зр╕Ур╕Чр╕╡р╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З

### Step-by-Step Calculation
```
1. р╕вр╕нр╕Фр╕Бр╣Ир╕нр╕Щр╕ар╕▓р╕йр╕╡ (Subtotal) = ╬г(quantity ├Ч unit_price) for all items
2. VAT 7% = Subtotal ├Ч 0.07
3. р╕вр╕нр╕Фр╕гр╕зр╕бр╕Бр╣Ир╕нр╕Щр╕кр╣Ир╕зр╕Щр╕ер╕Ф (Total) = Subtotal + VAT
4. р╕кр╣Ир╕зр╕Щр╕ер╕Фр╕Юр╕┤р╣Ар╕ир╕й = Total ├Ч (%) р╕лр╕гр╕╖р╕н р╕Ир╕│р╕Щр╕зр╕Щр╣Ар╕Зр╕┤р╕Щр╕Хр╕гр╕З
5. р╕вр╕нр╕Фр╕лр╕ер╕▒р╕Зр╕лр╕▒р╕Бр╕кр╣Ир╕зр╕Щр╕ер╕Ф = Total - р╕кр╣Ир╕зр╕Щр╕ер╕Фр╕Юр╕┤р╣Ар╕ир╕й
6. р╕ар╕▓р╕йр╕╡р╕лр╕▒р╕Б р╕У р╕Чр╕╡р╣Ир╕Ир╣Ир╕▓р╕в = Subtotal ├Ч р╕нр╕▒р╕Хр╕гр╕▓р╕ар╕▓р╕йр╕╡  тнР (р╕Ир╕▓р╕Бр╕вр╕нр╕Фр╕Бр╣Ир╕нр╕Щр╕ар╕▓р╕йр╕╡)
7. р╕вр╕нр╕Фр╕кр╕╕р╕Чр╕Шр╕┤р╕кр╕╕р╕Фр╕Чр╣Йр╕▓р╕в = р╕вр╕нр╕Фр╕лр╕ер╕▒р╕Зр╕лр╕▒р╕Бр╕кр╣Ир╕зр╕Щр╕ер╕Ф - р╕ар╕▓р╕йр╕╡р╕лр╕▒р╕Б р╕У р╕Чр╕╡р╣Ир╕Ир╣Ир╕▓р╕в
```

### тЬЕ р╕Бр╕▓р╕гр╣Бр╕Бр╣Йр╣Др╕Вр╕кр╕│р╕Др╕▒р╕Н
**р╣Ар╕Фр╕┤р╕б:** р╕ар╕▓р╕йр╕╡р╕лр╕▒р╕Б р╕У р╕Чр╕╡р╣Ир╕Ир╣Ир╕▓р╕в р╕Др╕│р╕Щр╕зр╕Ур╕Ир╕▓р╕Б `netAfterDiscount` тЭМ
**р╣Гр╕лр╕бр╣И:** р╕ар╕▓р╕йр╕╡р╕лр╕▒р╕Б р╕У р╕Чр╕╡р╣Ир╕Ир╣Ир╕▓р╕в р╕Др╕│р╕Щр╕зр╕Ур╕Ир╕▓р╕Б `subtotal` тЬЕ

## ЁЯОи UI/UX Improvements

### р╕кр╣Ир╕зр╕Щр╕ер╕Фр╕Юр╕┤р╣Ар╕ир╕й
- ЁЯОп Toggle р╣Ар╕ер╕╖р╕нр╕Бр╕гр╕░р╕лр╕зр╣Ир╕▓р╕З "р╣Ар╕Ыр╕нр╕гр╣Мр╣Ар╕Лр╣Зр╕Щр╕Хр╣М" р╣Бр╕ер╕░ "р╕Ир╕│р╕Щр╕зр╕Щр╣Ар╕Зр╕┤р╕Щ"
- ЁЯУК р╣Бр╕кр╕Фр╕Зр╕Бр╕▓р╕гр╕Др╕│р╕Щр╕зр╕Ур╣Бр╕Ър╕Ъ real-time
- тЪая╕П р╣Бр╕кр╕Фр╕Зр╕кр╕╡р╣Бр╕Фр╕Зр╣Ар╕Юр╕╖р╣Ир╕нр╣Ар╕Щр╣Йр╕Щр╕зр╣Ир╕▓р╣Ар╕Ыр╣Зр╕Щр╕Бр╕▓р╕гр╕лр╕▒р╕Б

### р╕ар╕▓р╕йр╕╡р╕лр╕▒р╕Б р╕У р╕Чр╕╡р╣Ир╕Ир╣Ир╕▓р╕в
- ЁЯОп Toggle р╣Ар╕ер╕╖р╕нр╕Б "р╕бр╕╡" р╕лр╕гр╕╖р╕н "р╣Др╕бр╣Ир╕бр╕╡"
- ЁЯУЭ р╣Бр╕кр╕Фр╕Зр╕Др╕│р╕нр╕Шр╕┤р╕Ър╕▓р╕вр╕зр╣Ир╕▓р╕Др╕│р╕Щр╕зр╕Ур╕Ир╕▓р╕Бр╕вр╕нр╕Фр╕Бр╣Ир╕нр╕Щр╕ар╕▓р╕йр╕╡
- ЁЯТб Helper text р╣Бр╕кр╕Фр╕Зр╕Ир╕│р╕Щр╕зр╕Щр╣Ар╕Зр╕┤р╕Щр╕Чр╕╡р╣Ир╣Гр╕Кр╣Йр╕Др╕│р╕Щр╕зр╕У
- тЪая╕П р╣Бр╕кр╕Фр╕Зр╕кр╕╡р╕кр╣Йр╕б/р╣Ар╕лр╕ер╕╖р╕нр╕З р╣Ар╕Юр╕╖р╣Ир╕нр╣Ар╕Щр╣Йр╕Щр╕зр╣Ир╕▓р╣Ар╕Ыр╣Зр╕Щр╕ар╕▓р╕йр╕╡

### р╕Бр╕▓р╕гр╣Бр╕кр╕Фр╕Зр╕Ьр╕ер╕Бр╕▓р╕гр╕Др╕│р╕Щр╕зр╕У
```
р╕вр╕нр╕Фр╕Бр╣Ир╕нр╕Щр╕ар╕▓р╕йр╕╡               10,000.00
VAT 7%                      700.00
р╕вр╕нр╕Фр╕гр╕зр╕бр╕Бр╣Ир╕нр╕Щр╕кр╣Ир╕зр╕Щр╕ер╕Ф           10,700.00
р╕лр╕▒р╕Бр╕кр╣Ир╕зр╕Щр╕ер╕Фр╕Юр╕┤р╣Ар╕ир╕й 5%            -535.00
р╕вр╕нр╕Фр╕лр╕ер╕▒р╕Зр╕лр╕▒р╕Бр╕кр╣Ир╕зр╕Щр╕ер╕Ф           10,165.00
р╕лр╕▒р╕Бр╕ар╕▓р╕йр╕╡ р╕У р╕Чр╕╡р╣Ир╕Ир╣Ир╕▓р╕в 3%         -300.00  тЖР р╕Ир╕▓р╕Б 10,000 ├Ч 3%
тХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХРтХР
р╕вр╕нр╕Фр╕кр╕╕р╕Чр╕Шр╕┤р╕кр╕╕р╕Фр╕Чр╣Йр╕▓р╕в             9,865.00
```

## ЁЯзк р╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ъ

### р╣Др╕Яр╕ер╣Мр╕Чр╕Фр╕кр╕нр╕Ъ
- тЬЕ р╕кр╕гр╣Йр╕▓р╕З `test_quotation_calculation.html` 
- ЁЯФН р╣Бр╕кр╕Фр╕Зр╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╕Бр╕▓р╕гр╕Др╕│р╕Щр╕зр╕У 3 р╕Бр╕гр╕Ур╕╡
- ЁЯУК JavaScript function р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Чр╕Фр╕кр╕нр╕Ъ

### р╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ъ Manual
```javascript
// р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╕Чр╕╡р╣И 1: р╕кр╣Ир╕зр╕Щр╕ер╕Ф 5% + р╕ар╕▓р╕йр╕╡р╕лр╕▒р╕Б р╕У р╕Чр╕╡р╣Ир╕Ир╣Ир╕▓р╕в 3%
calculateQuotation(10000, 0.07, 'percentage', 5, 3)
// Result: finalTotal = 9,865.00

// р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╕Чр╕╡р╣И 2: р╣Др╕бр╣Ир╕бр╕╡р╕кр╣Ир╕зр╕Щр╕ер╕Ф + р╕ар╕▓р╕йр╕╡р╕лр╕▒р╕Б р╕У р╕Чр╕╡р╣Ир╕Ир╣Ир╕▓р╕в 1%  
calculateQuotation(15000, 0.07, 'percentage', 0, 1)
// Result: finalTotal = 15,900.00

// р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╕Чр╕╡р╣И 3: р╕кр╣Ир╕зр╕Щр╕ер╕Фр╣Ар╕Ыр╣Зр╕Щр╕Ир╕│р╕Щр╕зр╕Щр╣Ар╕Зр╕┤р╕Щ + р╕ар╕▓р╕йр╕╡р╕лр╕▒р╕Б р╕У р╕Чр╕╡р╣Ир╕Ир╣Ир╕▓р╕в 3%
calculateQuotation(8000, 0.07, 'amount', 500, 3)
// Result: finalTotal = 7,820.00
```

## тЪб Next Steps

### р╕нр╕▓р╕Ир╕Хр╣Йр╕нр╕Зр╕Юр╕┤р╕Ир╕▓р╕гр╕Ур╕▓р╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Хр╕┤р╕б:
1. ЁЯФД р╕нр╕▒р╕Ыр╣Ар╕Фр╕Х QuotationDetailDialog р╣Гр╕лр╣Йр╕гр╕нр╕Зр╕гр╕▒р╕Ър╕Яр╕┤р╕ер╕Фр╣Мр╣Гр╕лр╕бр╣И
2. ЁЯУД р╕нр╕▒р╕Ыр╣Ар╕Фр╕Х PDF generation р╣Гр╕лр╣Йр╣Бр╕кр╕Фр╕Зр╕кр╣Ир╕зр╕Щр╕ер╕Фр╕Юр╕┤р╣Ар╕ир╕йр╣Бр╕ер╕░р╕ар╕▓р╕йр╕╡р╕лр╕▒р╕Б р╕У р╕Чр╕╡р╣Ир╕Ир╣Ир╕▓р╕в
3. ЁЯУК р╕нр╕▒р╕Ыр╣Ар╕Фр╕Х Invoice creation р╣Гр╕лр╣Йр╕кр╕╖р╕Ър╕Чр╕нр╕Фр╕Бр╕▓р╕гр╕Др╕│р╕Щр╕зр╕Ур╕Ир╕▓р╕Б Quotation
4. ЁЯзк Unit Tests р╕кр╕│р╕лр╕гр╕▒р╕Ъ backend calculation logic
5. ЁЯОи UI Testing р╕кр╕│р╕лр╕гр╕▒р╕Ъ form validation

## ЁЯПБ р╕кр╕гр╕╕р╕Ы

тЬЕ **р╕кр╕│р╣Ар╕гр╣Зр╕Ир╣Бр╕ер╣Йр╕з:** р╕гр╕░р╕Ър╕Ър╕кр╣Ир╕зр╕Щр╕ер╕Фр╕Юр╕┤р╣Ар╕ир╕йр╣Бр╕ер╕░р╕ар╕▓р╕йр╕╡р╕лр╕▒р╕Б р╕У р╕Чр╕╡р╣Ир╕Ир╣Ир╕▓р╕в  
тЬЕ **р╕Бр╕▓р╕гр╕Др╕│р╕Щр╕зр╕Ур╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З:** р╕ар╕▓р╕йр╕╡р╕лр╕▒р╕Б р╕У р╕Чр╕╡р╣Ир╕Ир╣Ир╕▓р╕в = р╕вр╕нр╕Фр╕Бр╣Ир╕нр╕Щр╕ар╕▓р╕йр╕╡ ├Ч р╕нр╕▒р╕Хр╕гр╕▓р╕ар╕▓р╕йр╕╡  
тЬЕ **UI/UX р╕кр╕бр╕Ър╕╣р╕гр╕Ур╣М:** р╣Бр╕кр╕Фр╕Зр╕Бр╕▓р╕гр╕Др╕│р╕Щр╕зр╕Ур╣Бр╕Ър╕Ър╕ер╕░р╣Ар╕нр╕╡р╕вр╕Фр╣Бр╕ер╕░р╣Ар╕Вр╣Йр╕▓р╣Гр╕Ир╕Зр╣Ир╕▓р╕в  
тЬЕ **Backend р╕Юр╕гр╣Йр╕нр╕бр╣Гр╕Кр╣Й:** Models, Controllers, р╣Бр╕ер╕░ API endpoints р╕Др╕гр╕Ър╕Цр╣Йр╕зр╕Щ

ЁЯОК **р╕гр╕░р╕Ър╕Ър╕Юр╕гр╣Йр╕нр╕бр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕кр╕гр╣Йр╕▓р╕Зр╣Гр╕Ър╣Ар╕кр╕Щр╕нр╕гр╕▓р╕Др╕▓р╕Чр╕╡р╣Ир╕бр╕╡р╕кр╣Ир╕зр╕Щр╕ер╕Фр╕Юр╕┤р╣Ар╕ир╕йр╣Бр╕ер╕░р╕ар╕▓р╕йр╕╡р╕лр╕▒р╕Б р╕У р╕Чр╕╡р╣Ир╕Ир╣Ир╕▓р╕в!**
